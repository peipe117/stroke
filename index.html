<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- åŠ å…¥ viewport-fit=cover ä»¥æ”¯æ´å…¨è¢å¹•å®‰å…¨å€åŸŸ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å­¸è¯èªå‘å‰èµ°(äºŒ) - ç­†é †ç·´ç¿’</title>
    <meta name="description" content="æ•¸ä½åŒ–è¯èªç”Ÿå­—ç­†é †ç·´ç¿’å·¥å…·ï¼Œæ”¯æ´è‡ªè¨‚ç”Ÿå­—èˆ‡æ•™è‚²éƒ¨å­—å…¸æŸ¥è©¢ã€‚">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ç­†é †ç·´ç¿’">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1250/1250617.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1250/1250617.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- OpenCC JS (ç¹ç°¡è½‰æ›åº«) -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap');

        body { 
            font-family: "TW-Kai", "BiauKai", "DFKai-SB", "KaiTi", "Noto Serif TC", serif; 
            background-color: #f8fafc;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            /* ä½¿ç”¨ dvh (dynamic viewport height) è§£æ±ºæ‰‹æ©Ÿç€è¦½å™¨ç¶²å€åˆ—å•é¡Œ */
            height: 100dvh;
            overflow: hidden;
        }
        
        /* ç°¡é«”æ¨¡å¼å­—é«” */
        body.mode-simp {
            font-family: "KaiTi", "STKaiti", "Noto Sans SC", sans-serif;
        }
        
        .ui-font { font-family: system-ui, -apple-system, sans-serif; }
        
        /* ç¹é«”å­—é«” */
        .char-font { font-family: "TW-Kai", "BiauKai", "DFKai-SB", "KaiTi", "Noto Serif TC", serif; }
        /* ç°¡é«”å­—é«” */
        .mode-simp .char-font { font-family: "KaiTi", "STKaiti", "Noto Sans SC", serif; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #writer-card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
            /* è®“å¡ç‰‡åœ¨æ¥µå°è¢å¹•å¯æ»¾å‹•ï¼Œé¿å…å…§å®¹è¢«åˆ‡æ‰ */
            max-height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .strip-item {
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }
        .strip-item.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.05);
            z-index: 10;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-bg { transition: opacity 0.3s ease-in-out; }
        .modal-bg.hidden { opacity: 0; pointer-events: none; }
        .modal-bg:not(.hidden) { opacity: 1; pointer-events: auto; }

        .tian-grid-bg {
            background-image: 
                linear-gradient(0deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            position: relative;
            background-color: #fff;
        }
        .tian-grid-bg::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 2px solid #e2e8f0; border-radius: 12px; pointer-events: none;
        }
        
        #writer-target { position: relative; z-index: 1; }
        
        @keyframes bounce-in {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* å­—å…¸å…§å®¹æ¨£å¼ */
        .dict-entry { border-bottom: 1px solid #f3f4f6; padding-bottom: 1rem; margin-bottom: 1rem; }
        .dict-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .dict-pronunciation { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem; }
        .dict-zhuyin { font-weight: bold; color: #1f2937; font-size: 1.1rem; }
        .dict-pinyin { color: #6b7280; font-size: 0.9rem; font-family: monospace; }
        .dict-def-item { margin-bottom: 0.5rem; }
        .dict-def-num { display: inline-block; width: 1.2em; color: #3b82f6; font-weight: bold; }
        .dict-def-text { color: #374151; line-height: 1.6; text-align: justify; }
        .dict-example { color: #6b7280; font-size: 0.9rem; margin-top: 0.2rem; padding-left: 1.2em; }
        
        /* Safe Area Padding for Footer */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ç°¡é«”æ¨¡å¼ä¸‹éš±è—æ³¨éŸ³ */
        .mode-simp .zhuyin-display {
            display: none !important;
        }
    </style>
</head>
<body class="flex flex-col text-gray-800">

    <!-- 1. é ‚éƒ¨å°èˆª (æ¸›å°‘ Padding ä»¥ç¯€çœç©ºé–“) -->
    <header class="bg-white shadow-sm z-20 flex-none ui-font pt-safe-top">
        <div class="max-w-6xl mx-auto px-4 py-2 flex flex-col gap-1.5 md:gap-2">
            <div class="flex justify-between items-center">
                <h1 class="text-lg md:text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                    <span class="text-blue-600 text-xl">âœï¸</span> 
                    <span class="char-font" id="app-title">å­¸è¯èªå‘å‰èµ°(äºŒ)</span>
                </h1>
                
                <div class="flex items-center gap-2">
                    <!-- éœéŸ³é–‹é—œ -->
                    <button onclick="toggleMute()" id="mute-btn" class="text-xl text-gray-400 hover:text-gray-600 transition p-1 rounded-full hover:bg-gray-100">
                        ğŸ”Š
                    </button>

                    <!-- ç¹ç°¡åˆ‡æ›æŒ‰éˆ• -->
                    <button onclick="toggleMode()" id="mode-btn" class="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg font-bold hover:bg-gray-200 transition shadow-sm border border-gray-200">
                        ç¹é«”
                    </button>

                    <!-- å®‰è£æŒ‰éˆ• -->
                    <button id="install-btn" onclick="triggerInstall()" class="hidden text-xs bg-pink-50 text-pink-600 px-3 py-1.5 rounded-lg font-bold hover:bg-pink-100 transition flex items-center gap-1 shadow-sm">
                        <span>ğŸ“²</span>
                        <span>å®‰è£</span>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center gap-2 pb-1">
                <select id="lesson-select" class="bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 outline-none flex-1 max-w-[260px]">
                    <!-- JS ç”Ÿæˆ -->
                </select>
            </div>
        </div>
    </header>

    <!-- 2. ä¸­é–“å¯«å­—æ¿å€ (ä½¿ç”¨ Flex-1 å’Œ min-h-0 ç¢ºä¿å…§å®¹å¯ç¸®æ”¾) -->
    <main id="stage-area" class="flex-1 min-h-0 relative flex flex-col items-center justify-center bg-gray-100 w-full overflow-hidden p-2">
        
        <!-- å·¦ç®­é ­ -->
        <button onclick="prevChar()" class="hidden md:flex absolute left-4 lg:left-8 top-1/2 -translate-y-1/2 w-12 h-12 bg-white rounded-full shadow-md items-center justify-center text-gray-400 hover:text-blue-600 hover:border-blue-400 transition z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>

        <!-- å¡ç‰‡å®¹å™¨ (èª¿æ•´æœ€å¤§å¯¬åº¦é©æ‡‰å¹³æ¿ï¼Œå…è¨±å…§éƒ¨æ²å‹•) -->
        <div id="writer-card" class="bg-white rounded-3xl p-4 md:p-6 flex flex-col items-center relative z-0 w-full max-w-[500px] h-auto no-scrollbar">
            
            <!-- æ‹¼éŸ³æ³¨éŸ³ -->
            <div class="w-full flex justify-between items-end mb-2 px-2 select-none min-h-[1.8rem]">
                <!-- åŠ å…¥ zhuyin-display é¡åˆ¥ï¼Œæ–¹ä¾¿ç°¡é«”æ¨¡å¼éš±è— -->
                <div class="text-gray-500 font-medium char-font text-xl md:text-2xl zhuyin-display" id="stage-zhuyin"></div>
                
                <!-- è‹¥æ³¨éŸ³éš±è—ï¼Œé å·¦å°é½Š -->
                <div class="flex-grow"></div> 

                <button onclick="speakCurrentChar()" class="p-1.5 rounded-full hover:bg-blue-50 text-blue-500 transition" title="æ’­æ”¾ç™¼éŸ³">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 md:h-7 md:w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
                <div class="text-blue-500 font-medium char-font text-xl md:text-2xl ml-3" id="stage-pinyin"></div>
            </div>

            <!-- Writer (ç§»é™¤å›ºå®š aspect-squareï¼Œæ”¹ç”± JS å‹•æ…‹è¨ˆç®—æœ€ä½³å°ºå¯¸) -->
            <div class="relative rounded-xl overflow-hidden tian-grid-bg bg-white shadow-inner mb-3 md:mb-4" id="writer-wrapper">
                <div id="writer-target"></div>
                
                <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden">
                    <div class="loader"></div>
                </div>
                <div id="error-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-10 hidden text-center px-4">
                    <p class="text-red-500 font-bold ui-font mb-1">è¼‰å…¥å¤±æ•—</p>
                    <p class="text-xs text-gray-500 mb-2">è«‹æª¢æŸ¥ç¶²è·¯</p>
                    <button onclick="reloadCurrent()" class="text-xs bg-gray-200 px-3 py-1.5 rounded-full ui-font hover:bg-gray-300 transition">é‡è©¦</button>
                </div>
                <div id="feedback-msg" class="absolute bottom-4 left-0 right-0 text-center font-bold text-lg pointer-events-none opacity-0 transition-opacity duration-300 char-font" style="text-shadow: 0 1px 2px rgba(255,255,255,1);"></div>
                <div id="current-best-score" class="absolute top-2 right-2 text-yellow-400 text-2xl filter drop-shadow-sm font-bold opacity-80 pointer-events-none"></div>
                <div id="data-source-tag" class="data-source-tag">TW</div>
            </div>

            <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
            <div class="w-full space-y-2 md:space-y-3 ui-font">
                <!-- ç¬¬ä¸€æ’ï¼šæ ¸å¿ƒç·´ç¿’ -->
                <div class="grid grid-cols-3 gap-2 md:gap-3">
                    <button onclick="startAnimation()" class="flex flex-col items-center justify-center py-2 md:py-2.5 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 active:scale-95 transition shadow-sm border border-blue-100">
                        <span class="text-lg md:text-xl">ğŸ‘€</span>
                        <span class="text-xs font-bold mt-1">æ¼”ç¤º</span>
                    </button>
                    <!-- ä¸­é–“æŒ‰éˆ•ï¼šæ”¹å›ç¶ è‰²é¢¨æ ¼èˆ‡æ‰‹å¯«åœ–ç¤ºï¼Œä½†åŠŸèƒ½ç¶­æŒ startQuiz -->
                    <button onclick="startQuiz()" class="flex flex-col items-center justify-center py-2 md:py-2.5 rounded-xl bg-green-50 text-green-600 hover:bg-green-100 active:scale-95 transition shadow-sm border border-green-100">
                        <span class="text-lg md:text-xl">âœï¸</span>
                        <span class="text-xs font-bold mt-1">ç·´ç¿’</span>
                    </button>
                    <!-- å³é‚ŠæŒ‰éˆ•æ”¹æˆå­—å…¸ -->
                    <button onclick="showDictionary()" class="flex flex-col items-center justify-center py-2 md:py-2.5 rounded-xl bg-orange-50 text-orange-600 hover:bg-orange-100 active:scale-95 transition shadow-sm border border-orange-100">
                        <span class="text-lg md:text-xl">ğŸ“–</span>
                        <span class="text-xs font-bold mt-1">å­—å…¸</span>
                    </button>
                </div>

                <!-- ç¬¬äºŒæ’ï¼šç®¡ç†åŠŸèƒ½ (åŸæœ¬çš„é•·æ¢å­—å…¸æŒ‰éˆ•å·²ç§»é™¤) -->
                <div class="grid grid-cols-2 gap-2 md:gap-3">
                    <button onclick="openCustomModal()" class="py-2 md:py-2.5 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition flex items-center justify-center gap-2 shadow-sm">
                        <span>âœï¸</span> è‡ªè¨‚ç”Ÿå­—
                    </button>
                    <button onclick="openScoreModal()" class="py-2 md:py-2.5 rounded-xl bg-yellow-50 text-yellow-700 font-bold hover:bg-yellow-100 transition flex items-center justify-center gap-2 shadow-sm border border-yellow-100">
                        <span>ğŸ“Š</span> æŸ¥çœ‹æˆç¸¾
                    </button>
                </div>
            </div>

            <div class="md:hidden absolute -bottom-8 text-gray-400 text-xs ui-font flex items-center gap-1 opacity-60">
                <span>â† å·¦å³æ»‘å‹•æ›å­— â†’</span>
            </div>
        </div>

        <button onclick="nextChar()" class="hidden md:flex absolute right-4 lg:right-8 top-1/2 -translate-y-1/2 w-12 h-12 bg-white rounded-full shadow-md items-center justify-center text-gray-400 hover:text-blue-600 hover:border-blue-400 transition z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>

    </main>

    <!-- 3. åº•éƒ¨é¸å–® (ç¸®å°é«˜åº¦ï¼Œé©æ‡‰æ‰‹æ©Ÿï¼ŒåŠ å…¥ safe-pb) -->
    <footer class="bg-white border-t border-gray-200 flex-none h-28 md:h-36 w-full z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-pb">
        <div class="h-full w-full max-w-6xl mx-auto p-2">
            <div id="character-strip" class="flex items-center gap-2 md:gap-3 overflow-x-auto h-full px-4 pt-1 pb-1 no-scrollbar scroll-smooth">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>
    </footer>

    <!-- ä¿®è¨‚è€…ç°½å -->
    <div class="flex-none bg-gray-50 text-center py-1 text-[10px] text-gray-400 ui-font border-t border-gray-100 safe-pb">
        Sophia Wong ä¿®è¨‚
    </div>

    <!-- 4. æ¸¬é©—çµæœå½ˆçª— -->
    <div id="result-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-[85%] max-w-sm shadow-2xl transform scale-100 transition-transform duration-300 flex flex-col items-center animate-bounce-in">
            <div class="text-5xl mb-3 animate-bounce" id="result-emoji">ğŸ‰</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-1 ui-font" id="result-title">æ¸¬é©—å®Œæˆ</h3>
            <div class="flex gap-2 my-2 text-3xl text-yellow-400 filter drop-shadow-sm" id="result-stars"></div>
            <div class="text-gray-600 ui-font mb-6 text-center bg-gray-50 px-6 py-2 rounded-xl mt-2 w-full">
                <div class="text-xs text-gray-400 mb-1">æœ¬æ¬¡å¾—åˆ†</div>
                <span id="result-score" class="text-4xl font-bold text-blue-600">--</span>
                <span class="text-sm font-medium">åˆ†</span>
            </div>
            <!-- Streak Msg -->
            <div id="streak-msg" class="hidden mb-4 text-pink-500 font-bold ui-font animate-pulse">
                ğŸ† é€£çºŒ 3 æ¬¡ 100 åˆ†ï¼å¤ªå¼·äº†ï¼ ğŸ†
            </div>
             <!-- Perfect Msg -->
            <div id="perfect-msg" class="hidden mb-4 text-purple-600 font-bold ui-font animate-pulse text-lg">
                ğŸ† æ­å–œï¼æœ¬èª²å…¨éƒ¨æ»¿åˆ†ï¼ ğŸ†
            </div>
            
            <button onclick="closeResultModal()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white rounded-xl font-bold shadow-lg transition ui-font flex items-center justify-center gap-2">
                <span>ç¹¼çºŒç·´ç¿’</span>
            </button>
        </div>
    </div>

    <!-- 5. æˆç¸¾å–®å½ˆçª— -->
    <div id="score-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-0 w-[90%] max-w-md shadow-2xl flex flex-col max-h-[85vh] overflow-hidden m-4">
            <div class="p-4 border-b bg-yellow-50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-yellow-800 flex items-center gap-2 ui-font">
                    <span>ğŸ“Š</span> å­¸ç¿’æˆç¸¾å–®
                </h3>
                <button onclick="closeScoreModal()" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-yellow-100 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto bg-white flex-grow ui-font">
                <div id="score-list" class="space-y-3"></div>
                <div id="no-score-msg" class="hidden text-center text-gray-400 py-8">
                    <div class="text-4xl mb-2">ğŸ“</div>
                    <p>é‚„æ²’æœ‰æ¸¬é©—ç´€éŒ„å–”ï¼<br>è¶•å¿«å»ç·´ç¿’å§ï¼</p>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 text-center text-xs text-gray-400">
                ç´€éŒ„å·²è‡ªå‹•å„²å­˜æ–¼æ­¤è£ç½®
            </div>
        </div>
    </div>

    <!-- 6. å­—å…¸è§£èªªå½ˆçª— -->
    <div id="dict-modal" class="modal-bg fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-t-3xl md:rounded-3xl p-6 w-full md:w-[90%] max-w-md shadow-2xl transform transition-transform duration-300 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 ui-font">
                    <span class="text-2xl">ğŸ“–</span> å­—å…¸è§£èªª
                </h3>
                <button onclick="closeDictModal()" class="text-gray-400 hover:text-gray-600 p-2 bg-gray-100 rounded-full transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="dict-content-area" class="overflow-y-auto pr-2 ui-font text-base text-gray-700 dict-content flex-grow">
                <!-- å­—å…¸å…§å®¹ -->
            </div>
            <div id="dict-loading" class="flex flex-col items-center justify-center py-8">
                <div class="loader mb-3"></div>
                <p class="text-sm text-gray-500 animate-pulse">æ­£åœ¨æŸ¥è©¢å­—å…¸...</p>
            </div>
            
            <div class="mt-4 pt-3 border-t flex justify-between items-center text-xs text-gray-400">
                <span>è³‡æ–™ä¾†æºï¼šèŒå…¸ (æ•™è‚²éƒ¨é‡ç·¨åœ‹èªè¾­å…¸)</span>
                <button onclick="openOfficialMoe()" class="text-blue-500 hover:underline font-bold">å‰å¾€æ•™è‚²éƒ¨å°å­—å…¸ â†—</button>
            </div>
        </div>
    </div>

    <!-- 7. è‡ªè¨‚ç”Ÿå­— Modal (Updated) -->
    <div id="custom-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-[90%] max-w-sm shadow-2xl p-6 relative overflow-hidden">
            
            <!-- Standard Content -->
            <div id="custom-modal-content">
                <h3 class="text-xl font-bold text-gray-800 mb-4 ui-font flex items-center gap-2">
                    <span>âœï¸</span> è‡ªè¨‚ç·´ç¿’ç”Ÿå­—
                </h3>
                <p class="text-sm text-gray-500 mb-2 ui-font">è«‹è¼¸å…¥æ‚¨æƒ³ç·´ç¿’çš„æ¼¢å­—ï¼ˆå¯éš¨æ™‚ä¿®æ”¹ï¼‰ï¼š</p>
                <textarea id="custom-input" rows="4" class="w-full border border-gray-300 rounded-xl p-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none char-font text-xl resize-none placeholder-gray-400 text-gray-900 bg-white" placeholder="ä¾‹å¦‚ï¼šæ–°å¹´å¿«æ¨‚"></textarea>
                
                <div class="flex flex-col gap-3">
                    <div class="flex gap-3">
                        <button onclick="closeCustomModal()" class="flex-1 py-2.5 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition ui-font">å–æ¶ˆ</button>
                        <button onclick="saveCustomWords()" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-md transition ui-font">é–‹å§‹ç·´ç¿’</button>
                    </div>
                    <!-- Delete Button -->
                    <button onclick="showDeleteConfirm()" class="w-full py-2 rounded-xl text-red-500 font-bold hover:bg-red-50 transition ui-font text-sm flex items-center justify-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        åˆªé™¤è‡ªè¨‚èª²ç¨‹
                    </button>
                </div>
            </div>

            <!-- Confirmation Overlay -->
            <div id="custom-delete-confirm" class="absolute inset-0 bg-white flex flex-col items-center justify-center hidden z-10 p-6 text-center">
                <div class="text-4xl mb-2">ğŸ—‘ï¸</div>
                <h4 class="text-lg font-bold text-gray-800 mb-2">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h4>
                <p class="text-sm text-gray-500 mb-6">è‡ªè¨‚ç”Ÿå­—ç´€éŒ„å°‡æœƒæ¸…ç©ºï¼Œç„¡æ³•å¾©åŸã€‚</p>
                <div class="flex gap-3 w-full">
                    <button onclick="hideDeleteConfirm()" class="flex-1 py-2 rounded-xl bg-gray-100 text-gray-600 font-bold">å–æ¶ˆ</button>
                    <button onclick="confirmDeleteCustom()" class="flex-1 py-2 rounded-xl bg-red-500 text-white font-bold shadow-md">ç¢ºå®šåˆªé™¤</button>
                </div>
            </div>

        </div>
    </div>

    <!-- 8. å®‰è£æ•™å­¸ Modal -->
    <div id="install-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-[85%] max-w-xs shadow-2xl flex flex-col items-center text-center animate-bounce-in">
            <h3 class="text-lg font-bold text-gray-800 mb-3 ui-font">åŠ å…¥ä¸»ç•«é¢</h3>
            <p class="text-sm text-gray-600 mb-4 ui-font leading-relaxed">
                å°‡æ­¤ç¶²é åŠ å…¥ä¸»ç•«é¢ï¼Œå³å¯åƒ App ä¸€æ¨£å…¨è¢å¹•ç·´ç¿’ï¼
            </p>
            <div class="bg-gray-100 rounded-lg p-3 text-sm text-gray-700 w-full mb-4 text-left ui-font">
                1. é»æ“Šä¸‹æ–¹çš„ <span class="font-bold text-blue-600">åˆ†äº«</span> æŒ‰éˆ• <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg><br>
                2. å¾€ä¸‹æ»‘æ‰¾åˆ° <span class="font-bold">ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</span><br>
                3. é»æ“Šå³ä¸Šè§’çš„ <span class="font-bold">ã€Œæ–°å¢ã€</span>
            </div>
            <button onclick="closeInstallModal()" class="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition ui-font">çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- è¤‡è£½æˆåŠŸæç¤º (Toast) -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm transition-opacity duration-300 opacity-0 pointer-events-none z-[60]">
        å·²è¤‡è£½ï¼Œè«‹è²¼ä¸ŠæŸ¥è©¢
    </div>

    <script>
        // èª²åæ¨™é¡Œ
        const lessonTitles = [
            "æ–°åŒå­¸", "æˆ‘çˆ¸çˆ¸åšç”Ÿæ„", "å»è¶…ç´šå¸‚å ´", "æˆ‘æƒ³åƒæ¼¢å ¡", 
            "ç§‹å¤©å¿«åˆ°äº†", "è¾²æ›†æ–°å¹´", "æ—©ä¸€é»ç¡è¦º", "æˆ‘çš„å¯µç‰©", 
            "éŸ³æ¨‚æ•™å®¤åœ¨åŒ—æ–¹", "å¤–å…¬ã€å¤–å©†ä½åœ¨å°ç£", "å»å‹•ç‰©åœ’", "æ‰“ç¶²è·¯é›»è©±"
        ];

        // è³‡æ–™åº« (æ–°å¢ simp æ¬„ä½)
        const vocabulary = [
            // ç¬¬ä¸€èª²
            { l: 1, char: 'æ–°', simp: 'æ–°', pinyin: 'xÄ«n', zhuyin: 'ã„’ã„§ã„£' },
            { l: 1, char: 'åŒ', simp: 'åŒ', pinyin: 'tÃ³ng', zhuyin: 'ã„Šã„¨ã„¥ËŠ' },
            { l: 1, char: 'å­¸', simp: 'å­¦', pinyin: 'xuÃ©', zhuyin: 'ã„’ã„©ã„ËŠ' },
            { l: 1, char: 'è‡ª', simp: 'è‡ª', pinyin: 'zÃ¬', zhuyin: 'ã„—Ë‹' },
            { l: 1, char: 'å·±', simp: 'å·±', pinyin: 'jÇ', zhuyin: 'ã„ã„§Ë‡' },
            { l: 1, char: 'å¹´', simp: 'å¹´', pinyin: 'niÃ¡n', zhuyin: 'ã„‹ã„§ã„¢ËŠ' },
            { l: 1, char: 'è·Ÿ', simp: 'è·Ÿ', pinyin: 'gÄ“n', zhuyin: 'ã„ã„£' },
            { l: 1, char: 'æ¯”', simp: 'æ¯”', pinyin: 'bÇ', zhuyin: 'ã„…ã„§Ë‡' },
            // ç¬¬äºŒèª²
            { l: 2, char: 'å¤–', simp: 'å¤–', pinyin: 'wÃ i', zhuyin: 'ã„¨ã„Ë‹' },
            { l: 2, char: 'å…¬', simp: 'å…¬', pinyin: 'gÅng', zhuyin: 'ã„ã„¨ã„¥' },
            { l: 2, char: 'ä»¥', simp: 'ä»¥', pinyin: 'yÇ', zhuyin: 'ã„§Ë‡' },
            { l: 2, char: 'å‰', simp: 'å‰', pinyin: 'qiÃ¡n', zhuyin: 'ã„‘ã„§ã„¢ËŠ' },
            { l: 2, char: 'å·¥', simp: 'å·¥', pinyin: 'gÅng', zhuyin: 'ã„ã„¨ã„¥' },
            { l: 2, char: 'ä½œ', simp: 'ä½œ', pinyin: 'zuÃ²', zhuyin: 'ã„—ã„¨ã„›Ë‹' },
            { l: 2, char: 'ç­', simp: 'ç­', pinyin: 'bÄn', zhuyin: 'ã„…ã„¢' },
            { l: 2, char: 'å¾Œ', simp: 'å', pinyin: 'hÃ²u', zhuyin: 'ã„ã„¡Ë‹' },
            // ç¬¬ä¸‰èª²
            { l: 3, char: 'å»', simp: 'å»', pinyin: 'qÃ¹', zhuyin: 'ã„‘ã„©Ë‹' },
            { l: 3, char: 'è¿‘', simp: 'è¿‘', pinyin: 'jÃ¬n', zhuyin: 'ã„ã„§ã„£Ë‹' },
            { l: 3, char: 'è²·', simp: 'ä¹°', pinyin: 'mÇi', zhuyin: 'ã„‡ã„Ë‡' },
            { l: 3, char: 'æ±', simp: 'ä¸œ', pinyin: 'dÅng', zhuyin: 'ã„‰ã„¨ã„¥' },
            { l: 3, char: 'è¥¿', simp: 'è¥¿', pinyin: 'xÄ«', zhuyin: 'ã„’ã„§' },
            { l: 3, char: 'é­š', simp: 'é±¼', pinyin: 'yÃº', zhuyin: 'ã„©ËŠ' },
            { l: 3, char: 'é‚„', simp: 'è¿˜', pinyin: 'hÃ¡i', zhuyin: 'ã„ã„ËŠ' },
            { l: 3, char: 'å¯', simp: 'å¯', pinyin: 'kÄ›', zhuyin: 'ã„ã„œË‡' },
            // ç¬¬å››èª²
            { l: 4, char: 'å‡º', simp: 'å‡º', pinyin: 'chÅ«', zhuyin: 'ã„”ã„¨' },
            { l: 4, char: 'å…ˆ', simp: 'å…ˆ', pinyin: 'xiÄn', zhuyin: 'ã„’ã„§ã„¢' },
            { l: 4, char: 'é€±', simp: 'å‘¨', pinyin: 'zhÅu', zhuyin: 'ã„“ã„¡' },
            { l: 4, char: 'æœ«', simp: 'æœ«', pinyin: 'mÃ²', zhuyin: 'ã„‡ã„›Ë‹' },
            { l: 4, char: 'æ™š', simp: 'æ™š', pinyin: 'wÇn', zhuyin: 'ã„¨ã„¢Ë‡' },
            { l: 4, char: 'è›‹', simp: 'è›‹', pinyin: 'dÃ n', zhuyin: 'ã„‰ã„¢Ë‹' },
            { l: 4, char: 'é£¯', simp: 'é¥­', pinyin: 'fÃ n', zhuyin: 'ã„ˆã„¢Ë‹' },
            { l: 4, char: 'ç¾', simp: 'ç°', pinyin: 'xiÃ n', zhuyin: 'ã„’ã„§ã„¢Ë‹' },
            { l: 4, char: 'é»', simp: 'ç‚¹', pinyin: 'diÇn', zhuyin: 'ã„‰ã„§ã„¢Ë‡' },
            // ç¬¬äº”èª²
            { l: 5, char: 'é»ƒ', simp: 'é»„', pinyin: 'huÃ¡ng', zhuyin: 'ã„ã„¨ã„¤ËŠ' },
            { l: 5, char: 'ç¶ ', simp: 'ç»¿', pinyin: 'lÇœ', zhuyin: 'ã„Œã„©Ë‹' },
            { l: 5, char: 'è‰²', simp: 'è‰²', pinyin: 'sÃ¨', zhuyin: 'ã„™ã„œË‹' },
            { l: 5, char: 'æ™‚', simp: 'æ—¶', pinyin: 'shÃ­', zhuyin: 'ã„•ËŠ' },
            { l: 5, char: 'å€™', simp: 'å€™', pinyin: 'hÃ²u', zhuyin: 'ã„ã„¡Ë‹' },
            { l: 5, char: 'èŠ±', simp: 'èŠ±', pinyin: 'huÄ', zhuyin: 'ã„ã„¨ã„š' },
            { l: 5, char: 'å­', simp: 'å­', pinyin: 'zi', zhuyin: 'Ë™ã„—' },
            { l: 5, char: 'ç´…', simp: 'çº¢', pinyin: 'hÃ³ng', zhuyin: 'ã„ã„¨ã„¥ËŠ' },
            { l: 5, char: 'ç™½', simp: 'ç™½', pinyin: 'bÃ¡i', zhuyin: 'ã„…ã„ËŠ' },
            // ç¬¬å…­èª²
            { l: 6, char: 'èªª', simp: 'è¯´', pinyin: 'shuÅ', zhuyin: 'ã„•ã„¨ã„›' },
            { l: 6, char: 'å°', simp: 'å¯¹', pinyin: 'duÃ¬', zhuyin: 'ã„‰ã„¨ã„ŸË‹' },
            { l: 6, char: 'æ˜Ÿ', simp: 'æ˜Ÿ', pinyin: 'xÄ«ng', zhuyin: 'ã„’ã„§ã„¥' },
            { l: 6, char: 'æœŸ', simp: 'æœŸ', pinyin: 'qÃ­', zhuyin: 'ã„‘ã„§ËŠ' },
            { l: 6, char: 'æœƒ', simp: 'ä¼š', pinyin: 'huÃ¬', zhuyin: 'ã„ã„¨ã„ŸË‹' },
            { l: 6, char: 'æ¯', simp: 'æ¯', pinyin: 'mÄ›i', zhuyin: 'ã„‡ã„ŸË‡' },
            { l: 6, char: 'çµ¦', simp: 'ç»™', pinyin: 'gÄ›i', zhuyin: 'ã„ã„ŸË‡' },
            { l: 6, char: 'å¦‚', simp: 'å¦‚', pinyin: 'rÃº', zhuyin: 'ã„–ã„¨ËŠ' },
            { l: 6, char: 'æœ', simp: 'æœ', pinyin: 'guÇ’', zhuyin: 'ã„ã„¨ã„›Ë‡' },
            // ç¬¬ä¸ƒèª²
            { l: 7, char: 'èµ·', simp: 'èµ·', pinyin: 'qÇ', zhuyin: 'ã„‘ã„§Ë‡' },
            { l: 7, char: 'ç´¯', simp: 'ç´¯', pinyin: 'lÃ¨i', zhuyin: 'ã„Œã„ŸË‹' },
            { l: 7, char: 'æ—©', simp: 'æ—©', pinyin: 'zÇo', zhuyin: 'ã„—ã„ Ë‡' },
            { l: 7, char: 'æ´—', simp: 'æ´—', pinyin: 'xÇ', zhuyin: 'ã„’ã„§Ë‡' },
            { l: 7, char: 'æ˜¨', simp: 'æ˜¨', pinyin: 'zuÃ³', zhuyin: 'ã„—ã„¨ã„›ËŠ' },
            { l: 7, char: 'é', simp: 'è¿‡', pinyin: 'guÃ²', zhuyin: 'ã„ã„¨ã„›Ë‹' },
            { l: 7, char: 'åˆ¥', simp: 'åˆ«', pinyin: 'biÃ©', zhuyin: 'ã„…ã„§ã„ËŠ' },
            { l: 7, char: 'å¿˜', simp: 'å¿˜', pinyin: 'wÃ ng', zhuyin: 'ã„¨ã„¤Ë‹' },
            { l: 7, char: 'ç”¨', simp: 'ç”¨', pinyin: 'yÃ²ng', zhuyin: 'ã„©ã„¥Ë‹' },
            { l: 7, char: 'è‡‰', simp: 'è„¸', pinyin: 'liÇn', zhuyin: 'ã„Œã„§ã„¢Ë‡' },
            // ç¬¬å…«èª²
            { l: 8, char: 'é€', simp: 'é€', pinyin: 'sÃ²ng', zhuyin: 'ã„™ã„¨ã„¥Ë‹' },
            { l: 8, char: 'éš»', simp: 'åª', pinyin: 'zhÄ«', zhuyin: 'ã„“' },
            { l: 8, char: 'ç‹—', simp: 'ç‹—', pinyin: 'gÇ’u', zhuyin: 'ã„ã„¡Ë‡' },
            { l: 8, char: 'å¸¶', simp: 'å¸¦', pinyin: 'dÃ i', zhuyin: 'ã„‰ã„Ë‹' },
            { l: 8, char: 'æ•£', simp: 'æ•£', pinyin: 'sÃ n', zhuyin: 'ã„™ã„¢Ë‹' },
            { l: 8, char: 'æ­¥', simp: 'æ­¥', pinyin: 'bÃ¹', zhuyin: 'ã„…ã„¨Ë‹' },
            { l: 8, char: 'è²“', simp: 'çŒ«', pinyin: 'mÄo', zhuyin: 'ã„‡ã„ ' },
            { l: 8, char: 'é', simp: 'é', pinyin: 'fÄ“i', zhuyin: 'ã„ˆã„Ÿ' },
            { l: 8, char: 'æ„›', simp: 'çˆ±', pinyin: 'Ã i', zhuyin: 'ã„Ë‹' },
            // ç¬¬ä¹èª²
            { l: 9, char: 'å—', simp: 'å—', pinyin: 'nÃ¡n', zhuyin: 'ã„‹ã„¢ËŠ' },
            { l: 9, char: 'åŒ—', simp: 'åŒ—', pinyin: 'bÄ›i', zhuyin: 'ã„…ã„ŸË‡' },
            { l: 9, char: 'æ–¹', simp: 'æ–¹', pinyin: 'fÄng', zhuyin: 'ã„ˆã„¤' },
            { l: 9, char: 'è£¡', simp: 'é‡Œ', pinyin: 'lÇ', zhuyin: 'ã„Œã„§Ë‡' },
            { l: 9, char: 'æ ¡', simp: 'æ ¡', pinyin: 'xiÃ o', zhuyin: 'ã„’ã„§ã„ Ë‹' },
            { l: 9, char: 'é–€', simp: 'é—¨', pinyin: 'mÃ©n', zhuyin: 'ã„‡ã„£ËŠ' },
            { l: 9, char: 'å£', simp: 'å£', pinyin: 'kÇ’u', zhuyin: 'ã„ã„¡Ë‡' },
            { l: 9, char: 'å› ', simp: 'å› ', pinyin: 'yÄ«n', zhuyin: 'ã„§ã„£' },
            { l: 9, char: 'ç‚º', simp: 'ä¸º', pinyin: 'wÃ¨i', zhuyin: 'ã„¨ã„ŸË‹' },
            { l: 9, char: 'æ‰€', simp: 'æ‰€', pinyin: 'suÇ’', zhuyin: 'ã„™ã„¨ã„›Ë‡' },
            // ç¬¬åèª²
            { l: 10, char: 'æœ¬', simp: 'æœ¬', pinyin: 'bÄ›n', zhuyin: 'ã„…ã„£Ë‡' },
            { l: 10, char: 'è‘—', simp: 'ç€', pinyin: 'zhe', zhuyin: 'Ë™ã„“ã„œ' },
            { l: 10, char: 'é€€', simp: 'é€€', pinyin: 'tuÃ¬', zhuyin: 'ã„Šã„¨ã„ŸË‹' },
            { l: 10, char: 'ä¼‘', simp: 'ä¼‘', pinyin: 'xiÅ«', zhuyin: 'ã„’ã„§ã„¡' },
            { l: 10, char: 'æ¬¡', simp: 'æ¬¡', pinyin: 'cÃ¬', zhuyin: 'ã„˜Ë‹' },
            { l: 10, char: 'æ—…', simp: 'æ—…', pinyin: 'lÇš', zhuyin: 'ã„Œã„©Ë‡' },
            { l: 10, char: 'è¡Œ', simp: 'è¡Œ', pinyin: 'xÃ­ng', zhuyin: 'ã„’ã„§ã„¥ËŠ' },
            { l: 10, char: 'æ³•', simp: 'æ³•', pinyin: 'fÇ', zhuyin: 'ã„ˆã„šË‡' },
            { l: 10, char: 'åœ‹', simp: 'å›½', pinyin: 'guÃ³', zhuyin: 'ã„ã„¨ã„›ËŠ' },
            // ç¬¬åä¸€èª²
            { l: 11, char: 'å‹•', simp: 'åŠ¨', pinyin: 'dÃ²ng', zhuyin: 'ã„‰ã„¨ã„¥Ë‹' },
            { l: 11, char: 'ç‰©', simp: 'ç‰©', pinyin: 'wÃ¹', zhuyin: 'ã„¨Ë‹' },
            { l: 11, char: 'åœ’', simp: 'å›­', pinyin: 'yuÃ¡n', zhuyin: 'ã„©ã„¢ËŠ' },
            { l: 11, char: 'è€', simp: 'è€', pinyin: 'lÇo', zhuyin: 'ã„Œã„ Ë‡' },
            { l: 11, char: 'å¸Œ', simp: 'å¸Œ', pinyin: 'xÄ«', zhuyin: 'ã„’ã„§' },
            { l: 11, char: 'æœ›', simp: 'æœ›', pinyin: 'wÃ ng', zhuyin: 'ã„¨ã„¤Ë‹' },
            { l: 11, char: 'ä½†', simp: 'ä½†', pinyin: 'dÃ n', zhuyin: 'ã„‰ã„¢Ë‹' },
            { l: 11, char: 'èƒ–', simp: 'èƒ–', pinyin: 'pÃ ng', zhuyin: 'ã„†ã„¤Ë‹' },
            { l: 11, char: 'çœŸ', simp: 'çœŸ', pinyin: 'zhÄ“n', zhuyin: 'ã„“ã„£' },
            { l: 11, char: 'é•·', simp: 'é•¿', pinyin: 'chÃ¡ng', zhuyin: 'ã„”ã„¤ËŠ' },
            // ç¬¬åäºŒèª²
            { l: 12, char: 'ä¹…', simp: 'ä¹…', pinyin: 'jiÇ”', zhuyin: 'ã„ã„§ã„¡Ë‡' },
            { l: 12, char: 'è©±', simp: 'è¯', pinyin: 'huÃ ', zhuyin: 'ã„ã„¨ã„šË‹' },
            { l: 12, char: 'é«˜', simp: 'é«˜', pinyin: 'gÄo', zhuyin: 'ã„ã„ ' },
            { l: 12, char: 'èª²', simp: 'è¯¾', pinyin: 'kÃ¨', zhuyin: 'ã„ã„œË‹' },
            { l: 12, char: 'å¯«', simp: 'å†™', pinyin: 'xiÄ›', zhuyin: 'ã„’ã„§ã„Ë‡' },
            { l: 12, char: 'æ²’', simp: 'æ²¡', pinyin: 'mÃ©i', zhuyin: 'ã„‡ã„ŸËŠ' },
            { l: 12, char: 'é¡Œ', simp: 'é¢˜', pinyin: 'tÃ­', zhuyin: 'ã„Šã„§ËŠ' },
            { l: 12, char: 'å®š', simp: 'å®š', pinyin: 'dÃ¬ng', zhuyin: 'ã„‰ã„§ã„¥Ë‹' },
            { l: 12, char: 'æ„', simp: 'æ„', pinyin: 'yÃ¬', zhuyin: 'ã„§Ë‹' },
            { l: 12, char: 'æ€', simp: 'æ€', pinyin: 'sÄ«', zhuyin: 'ã„™' }
        ];

        let writer = null;
        let currentLesson = 1;
        let lessonVocab = [];
        let customVocab = []; 
        let currentIndex = 0;
        const SCORE_KEY = 'hanzi_learning_scores_v2';
        const CUSTOM_VOCAB_KEY = 'hanzi_learning_custom_vocab'; 
        let scoreHistory = {};
        
        // æ¨¡å¼ç‹€æ…‹ï¼štrue = ç°¡é«”, false = ç¹é«”
        let isSimplified = false;
        
        // éœéŸ³ç‹€æ…‹
        let isMuted = false;
        
        // New State for Streak
        let streakCount = 0;
        let fireworksInterval = null; // ç”¨ä¾†å­˜å–ç…™ç«çš„ Interval ID

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load Mode preference
            const savedMode = localStorage.getItem('hanzi_mode');
            if (savedMode === 'simplified') {
                isSimplified = true;
            }
            updateModeUI();

            loadScores();
            loadCustomVocab();
            initLessonSelect();
            updateLessonData(1);
            setupTouchEvents();
            setupKeyboardEvents();
            initInstallPrompt();
            
            // Handle Resize efficiently
            window.addEventListener('resize', debounce(() => {
                renderStage();
            }, 300));
        });
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Logic ---
        function toggleMode() {
            isSimplified = !isSimplified;
            localStorage.setItem('hanzi_mode', isSimplified ? 'simplified' : 'traditional');
            updateModeUI();
            
            // æ¨¡å¼åˆ‡æ›æ™‚ï¼Œç‚ºäº†ç¢ºä¿æ­£ç¢ºè¼‰å…¥å°æ‡‰å­—é«”ç­†é †ï¼Œé€™è£¡æˆ‘å€‘å¼·åˆ¶éŠ·æ¯€ writer é‡å»º
            if(writer) {
                writer = null; 
                document.getElementById('writer-target').innerHTML = '';
            }
            
            // Re-render
            updateLessonData(currentLesson === 'custom' ? 'custom' : currentLesson);
        }

        function updateModeUI() {
            const btn = document.getElementById('mode-btn');
            const title = document.getElementById('app-title');
            
            if (isSimplified) {
                document.body.classList.add('mode-simp');
                btn.innerText = 'ç®€ä½“';
                title.innerText = 'å­¦åè¯­å‘å‰èµ°(äºŒ)';
            } else {
                document.body.classList.remove('mode-simp');
                btn.innerText = 'ç¹é«”';
                title.innerText = 'å­¸è¯èªå‘å‰èµ°(äºŒ)';
            }
        }
        
        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if(isMuted) {
                btn.innerText = 'ğŸ”‡';
                btn.classList.add('text-red-400');
                window.speechSynthesis.cancel();
            } else {
                btn.innerText = 'ğŸ”Š';
                btn.classList.remove('text-red-400');
            }
        }

        // Helper to get character based on mode
        function getChar(item) {
            if (isSimplified && item.simp) {
                return item.simp;
            }
            return item.char;
        }

        function loadScores() {
            try {
                const stored = localStorage.getItem(SCORE_KEY);
                if (stored) scoreHistory = JSON.parse(stored);
            } catch (e) { console.error(e); }
        }
        
        function loadCustomVocab() {
            try {
                const stored = localStorage.getItem(CUSTOM_VOCAB_KEY);
                if (stored) customVocab = JSON.parse(stored);
            } catch (e) { console.error(e); }
        }

        function saveScore(char, score) {
            // Always save score against the displayed char
            const currentBest = scoreHistory[char] || 0;
            if (score > currentBest) {
                scoreHistory[char] = score;
                localStorage.setItem(SCORE_KEY, JSON.stringify(scoreHistory));
            }
        }

        function getStars(score) {
            if (score === 100) return 'â­â­â­';
            if (score >= 80) return 'â­â­';
            if (score >= 60) return 'â­';
            return '';
        }

        function initLessonSelect() {
            const select = document.getElementById('lesson-select');
            select.innerHTML = ''; 
            
            for(let i=1; i<=12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `ç¬¬ ${i} èª²ï¼š${lessonTitles[i-1]}`;
                select.appendChild(opt);
            }
            
            const customOpt = document.createElement('option');
            customOpt.value = 'custom';
            customOpt.innerText = 'âœ¨ è‡ªè¨‚èª²ç¨‹';
            select.appendChild(customOpt);

            select.addEventListener('change', (e) => {
                const val = e.target.value;
                updateLessonData(val === 'custom' ? 'custom' : parseInt(val));
            });
        }

        function updateLessonData(lesson) {
            currentLesson = lesson;
            streakCount = 0; // Reset streak on lesson change
            
            if (lesson === 'custom') {
                lessonVocab = customVocab;
            } else {
                lessonVocab = vocabulary.filter(item => item.l === currentLesson);
            }
            
            currentIndex = 0;
            renderStrip();
            renderStage();
        }

        function renderStrip() {
            const strip = document.getElementById('character-strip');
            strip.innerHTML = '';
            
            if (lessonVocab.length === 0 && currentLesson === 'custom') {
                strip.innerHTML = `<div class="flex items-center justify-center w-full text-gray-400 text-sm h-full">å°šæœªåŠ å…¥è‡ªè¨‚å­—ï¼Œè«‹é»æ“Šä¸Šæ–¹ã€Œè‡ªè¨‚ã€æŒ‰éˆ•</div>`;
                return;
            }
            
            lessonVocab.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `strip-item flex-none w-14 h-16 md:w-20 md:h-24 bg-white rounded-lg md:rounded-xl flex flex-col items-center justify-center cursor-pointer border hover:border-blue-300 shadow-sm ${idx === currentIndex ? 'active ring-2 ring-blue-400' : ''}`;
                div.onclick = () => {
                    currentIndex = idx;
                    renderStripHighlight();
                    renderStage();
                };

                const displayChar = getChar(item);
                const score = scoreHistory[displayChar];
                const stars = score ? getStars(score) : '';
                const starHtml = stars ? `<div class="text-[8px] text-yellow-500 absolute top-1 right-1 leading-none">${stars}</div>` : '';

                const pinyinDisplay = item.pinyin ? item.pinyin : '';
                // ç°¡é«”æ¨¡å¼ä¸é¡¯ç¤ºæ³¨éŸ³
                const zhuyinDisplay = isSimplified ? '' : (item.zhuyin || '');

                div.innerHTML = `
                    ${starHtml}
                    <div class="text-[10px] md:text-xs text-gray-400 ui-font mb-0.5 md:mb-1 h-[14px]">${zhuyinDisplay}</div>
                    <div class="text-2xl md:text-3xl char-font leading-none text-gray-800">${displayChar}</div>
                    <div class="text-[8px] md:text-[10px] text-blue-500 ui-font mt-0.5 md:mt-1 font-semibold">${pinyinDisplay}</div>
                `;
                strip.appendChild(div);
            });
            scrollToActiveStrip();
        }

        function renderStripHighlight() {
            const items = document.querySelectorAll('.strip-item');
            items.forEach((item, idx) => {
                if (idx === currentIndex) item.classList.add('active', 'ring-2', 'ring-blue-400');
                else item.classList.remove('active', 'ring-2', 'ring-blue-400');
            });
            scrollToActiveStrip();
        }

        function scrollToActiveStrip() {
            const strip = document.getElementById('character-strip');
            const activeEl = strip.children[currentIndex];
            if (activeEl) {
                activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        // --- Major Optimization: Reusing HanziWriter Instance ---
        function renderStage() {
            clearEffects(); // æ¸…é™¤æ®˜ç•™ç‰¹æ•ˆ

            if (lessonVocab.length === 0) {
                document.getElementById('writer-target').innerHTML = '';
                document.getElementById('stage-zhuyin').innerText = '';
                document.getElementById('stage-pinyin').innerText = '';
                return;
            }
            
            const item = lessonVocab[currentIndex];
            const displayChar = getChar(item);

            document.getElementById('stage-zhuyin').innerText = item.zhuyin || '';
            document.getElementById('stage-pinyin').innerText = item.pinyin || '';

            // ç¢ºä¿éŒ¯èª¤è¨Šæ¯èˆ‡ Loading ç‹€æ…‹é‡ç½®
            document.getElementById('feedback-msg').style.opacity = 0;
            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('data-source-tag').innerText = '';
            
            const bestScore = scoreHistory[displayChar];
            const bestEl = document.getElementById('current-best-score');
            bestEl.innerText = bestScore ? `${bestScore}` : '';

            // æ™ºæ…§å‹å°ºå¯¸è¨ˆç®—
            const card = document.getElementById('writer-card');
            const wrapper = document.getElementById('writer-wrapper');
            
            const availableWidth = card.clientWidth - 48;
            const maxSafeHeight = window.innerHeight * 0.55; 
            const size = Math.min(availableWidth, maxSafeHeight, 500);
            
            // è¨­å®šå®¹å™¨å¤§å°
            const target = document.getElementById('writer-target');
            target.style.width = `${size}px`;
            target.style.height = `${size}px`;
            wrapper.style.width = `${size}px`; 
            wrapper.style.height = `${size}px`;

            if (writer) {
                // å¦‚æœ writer å·²ç¶“å­˜åœ¨ï¼Œæ›´æ–°å¤§å°ä¸¦åˆ‡æ›å­—å…ƒ (æ•ˆèƒ½å„ªåŒ–é»)
                writer.updateDimensions({ width: size, height: size });
                
                // ä½¿ç”¨ setCharacter åˆ‡æ›å­—å…ƒ
                writer.setCharacter(displayChar);
                
                // ç”±æ–¼ setCharacter æ˜¯ Promiseï¼Œæˆ‘å€‘éœ€è¦æ‰‹å‹•è™•ç† Loading ç‹€æ…‹
                // ä½† HanziWriter å…§éƒ¨æœƒæœ‰å¿«å–ï¼Œé€šå¸¸å¾ˆå¿«ã€‚
                // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘å‡è¨­å®ƒæœƒè§¸ç™¼ onLoadCharDataSuccess å›å‘¼ (ä½†åœ¨ setCharacter ä¸­å…¶å¯¦ä¸æœƒè§¸ç™¼ create æ™‚çš„ hook)
                // æ‰€ä»¥æˆ‘å€‘æ‰‹å‹•æ¨¡æ“¬è¼‰å…¥æµç¨‹:
                
                // é€™è£¡æ˜¯ä¸€å€‹å°æŠ€å·§ï¼šsetCharacter é›–ç„¶å¿«ï¼Œä½†æˆ‘å€‘å¸Œæœ›ä¿æŒä¸€è‡´çš„ã€Œæ¼”ç¤ºã€é«”é©—
                // æˆ‘å€‘å¯ä»¥åˆ©ç”¨ setCharacter çš„ callback
                
                // æ›´å¥½çš„åšæ³•ï¼šé‡æ–°ç¶å®š writer çš„è¡Œç‚ºæ¯”è¼ƒè¤‡é›œï¼Œ
                // æœ€ç©©å®šçš„ reuse æ–¹å¼æ˜¯å‘¼å« setCharacter å¾Œï¼Œæ‰‹å‹•è§¸ç™¼å‹•ç•«
                
                // æˆ‘å€‘ç¨å¾®ä¿®æ”¹é‚è¼¯ï¼šä¸ä¾è³´ create çš„ callbackï¼Œè€Œæ˜¯çµ±ä¸€è™•ç†
                loadCharIntoWriter(displayChar);

            } else {
                // å¦‚æœ writer ä¸å­˜åœ¨ï¼Œå‰‡å»ºç«‹ (åˆå§‹åŒ–)
                createNewWriter(displayChar, size);
            }
        }

        // ç¨ç«‹å‡ºå»ºç«‹ Writer çš„é‚è¼¯
        function createNewWriter(char, size) {
            try {
                writer = HanziWriter.create('writer-target', char, {
                    width: size,
                    height: size,
                    padding: 10,
                    showOutline: true,
                    strokeAnimationSpeed: 1,
                    delayBetweenStrokes: 400,
                    radicalColor: '#3b82f6',
                    strokeColor: '#334155',
                    outlineColor: '#cbd5e1',
                    
                    // é€™äº› callback åªåœ¨ create æ™‚è¢«ç¶å®šï¼ŒsetCharacter ä¸æœƒé‡è¤‡è§¸ç™¼å®ƒå€‘
                    // æ‰€ä»¥æˆ‘å€‘éœ€è¦ä¸€å€‹çµ±ä¸€çš„è¼‰å…¥å‡½å¼ä¾†ç®¡ç† "åˆ‡æ›å­—å…ƒå¾Œ" çš„è¡Œç‚º
                    onLoadCharDataError: function(err) {
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('error-msg').classList.remove('hidden');
                    },
                    charDataLoader: getCharDataLoader()
                });
                
                // åˆå§‹å»ºç«‹å¾Œï¼Œä¹Ÿèµ°çµ±ä¸€çš„è¼‰å…¥æµç¨‹ç¢ºä¿å‹•ç•«ä¸€è‡´
                loadCharIntoWriter(char);

            } catch(e) {
                console.error(e);
            }
        }

        // çµ±ä¸€çš„å­—å…ƒè¼‰å…¥èˆ‡å‹•ç•«è§¸ç™¼é‚è¼¯
        function loadCharIntoWriter(char) {
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('error-msg').classList.add('hidden');

            // å‘¼å« setCharacter (å¦‚æœæ˜¯æ–°å»ºçš„ writerï¼Œé€™æœƒç«‹å³ resolve å› ç‚ºè³‡æ–™æ­£åœ¨è¼‰å…¥æˆ–å·²è¼‰å…¥)
            writer.setCharacter(char).then(() => {
                document.getElementById('loading-indicator').classList.add('hidden');
                writer.animateCharacter();
                // æª¢æŸ¥éœéŸ³
                if (!isMuted) {
                    setTimeout(speakCurrentChar, 300);
                }
            }).catch((err) => {
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('error-msg').classList.remove('hidden');
            });
        }

        // ç¨ç«‹å‡º DataLoader é‚è¼¯
        function getCharDataLoader() {
            return function(char, onComplete, onError) {
                const encodedChar = encodeURIComponent(char);
                const urlTraditional = `https://cdn.jsdelivr.net/gh/Artex/hanzi-writer-data-traditional@master/data/${encodedChar}.json`;
                const urlStandard = `https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${encodedChar}.json`;

                if (isSimplified) {
                    fetch(urlStandard)
                        .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                        .then(json => {
                            document.getElementById('data-source-tag').innerText = 'STD';
                            onComplete(json);
                        })
                        .catch(() => {
                            fetch(urlTraditional)
                                .then(res => res.json())
                                .then(json => {
                                    document.getElementById('data-source-tag').innerText = 'TW';
                                    onComplete(json);
                                })
                                .catch(onError);
                        });
                } else {
                    fetch(urlTraditional)
                        .then(res => { if (!res.ok) throw new Error(); return res.json(); })
                        .then(json => {
                            document.getElementById('data-source-tag').innerText = 'TW';
                            onComplete(json);
                        })
                        .catch(() => {
                            console.warn(`Switching to standard data for: ${char}`);
                            fetch(urlStandard)
                                .then(res => res.json())
                                .then(json => {
                                    document.getElementById('data-source-tag').innerText = 'STD';
                                    onComplete(json);
                                })
                                .catch(onError);
                        });
                }
            }
        }

        function reloadCurrent() {
            // å¼·åˆ¶é‡ç¹ª
            writer = null;
            document.getElementById('writer-target').innerHTML = '';
            renderStage();
        }

        function prevChar() {
            if (currentIndex > 0) {
                currentIndex--;
                renderStripHighlight();
                renderStage();
            }
        }

        function nextChar() {
            if (currentIndex < lessonVocab.length - 1) {
                currentIndex++;
                renderStripHighlight();
                renderStage();
            }
        }

        // Input Handling
        function setupTouchEvents() {
            const area = document.getElementById('stage-area');
            let touchStartX = 0;
            let touchEndX = 0;

            area.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});

            area.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});

            function handleSwipe() {
                const threshold = 50;
                if (touchEndX < touchStartX - threshold) nextChar();
                if (touchEndX > touchStartX + threshold) prevChar();
            }
        }
        
        function setupKeyboardEvents() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') prevChar();
                if (e.key === 'ArrowRight') nextChar();
            });
        }

        // Actions
        function speakCurrentChar() {
            if (isMuted) return; // éœéŸ³æª¢æŸ¥
            if (lessonVocab.length === 0) return;
            const item = lessonVocab[currentIndex];
            const char = getChar(item);
            
            window.speechSynthesis.cancel();
            
            const u = new SpeechSynthesisUtterance(char);
            // æ ¹æ“šæ¨¡å¼åˆ‡æ›èªè¨€å£éŸ³
            u.lang = isSimplified ? 'zh-CN' : 'zh-TW';
            u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        function showFeedback(text, color) {
            const el = document.getElementById('feedback-msg');
            el.innerText = text;
            el.style.color = color;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 1500);
        }

        function startAnimation() {
            if(!writer) return;
            // æ¯æ¬¡é»æ“ŠåŠŸèƒ½éµä¹Ÿæ’­æ”¾è²éŸ³ (è‹¥æœªéœéŸ³)
            if(!isMuted) speakCurrentChar();
            
            writer.showOutline();
            writer.animateCharacter();
            showFeedback('æ¼”ç¤ºç­†é †', '#3b82f6');
        }

        function startPractice() {
            if(!writer) return;
            if(!isMuted) speakCurrentChar();
            
            writer.showOutline();
            writer.quiz({
                onMistake: () => showFeedback('åŠ æ²¹ï¼', '#ef4444'),
                onCorrectStroke: () => showFeedback('å¾ˆå¥½ï¼', '#22c55e'),
                onComplete: () => showFeedback('å®Œæˆï¼', '#22c55e')
            });
            showFeedback('é–‹å§‹ç·´ç¿’', '#22c55e');
        }

        // æ¸…é™¤ç‰¹æ•ˆ (é‡è¦å„ªåŒ–)
        function clearEffects() {
            if (fireworksInterval) {
                clearInterval(fireworksInterval);
                fireworksInterval = null;
            }
            confetti.reset();
        }

        // New Visual Effects
        function triggerFlowerShower() {
            var duration = 3000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.2 }, // Top Left
                    colors: ['#ffc0cb', '#ff69b4', '#ff1493', '#ffffff'], // Pink/White
                    scalar: 2, // Larger
                    drift: 1
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.2 }, // Top Right
                    colors: ['#ffc0cb', '#ff69b4', '#ff1493', '#ffffff'],
                    scalar: 2,
                    drift: -1
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        function triggerFireworks() {
            var duration = 5 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

            function randomInOut(min, max) {
              return Math.random() * (max - min) + min;
            }

            // æ¸…é™¤èˆŠçš„ timer
            if(fireworksInterval) clearInterval(fireworksInterval);

            fireworksInterval = setInterval(function() {
              var timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                return clearInterval(fireworksInterval);
              }

              var particleCount = 50 * (timeLeft / duration);
              // Random bursts
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.1, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }
        
        function triggerSimpleConfetti() {
             confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        function startQuiz() {
            if(!writer) return;
            if(!isMuted) speakCurrentChar();
            
            writer.showOutline(); // ä¿®æ”¹ï¼šæ¸¬é©—æ™‚é¡¯ç¤ºè¼ªå»“ï¼Œè·Ÿç·´ç¿’æ¨¡å¼ä¸€æ¨£

            writer.quiz({
                onMistake: function(strokeData) {
                    showFeedback('åŠ æ²¹ï¼', '#ef4444');
                    // ç§»é™¤éŒ¯èª¤æ™‚é–ƒçˆè¼ªå»“çš„é‚è¼¯ï¼Œå› ç‚ºç¾åœ¨è¼ªå»“å·²ç¶“å¸¸é§é¡¯ç¤ºäº†
                },
                onComplete: function(summaryData) {
                    const mistakes = summaryData.totalMistakes;
                    const score = Math.max(0, 100 - (mistakes * 10));
                    const item = lessonVocab[currentIndex];
                    const char = getChar(item);
                    
                    // 1. Update Score
                    saveScore(char, score);
                    
                    // 2. Update Streak
                    if (score === 100) {
                        streakCount++;
                    } else {
                        streakCount = 0;
                    }
                    
                    // 3. Check for Perfect Lesson (All chars have 100 score in history)
                    const isPerfectLesson = lessonVocab.every(word => (scoreHistory[getChar(word)] || 0) === 100);

                    renderStrip(); 
                    
                    // 4. Trigger Effects & Show Modal
                    let effectType = 'normal';
                    
                    if (isPerfectLesson) {
                        effectType = 'perfect_lesson'; // Rename for clarity
                        setTimeout(triggerFireworks, 500);
                    } else if (streakCount > 0 && streakCount % 3 === 0) {
                        effectType = 'streak_fireworks'; // Changed from 'flowers' to 'streak_fireworks'
                        setTimeout(triggerFireworks, 500); // Changed function call
                    } else if (score === 100) {
                         setTimeout(triggerSimpleConfetti, 500);
                    }

                    showResultModal(score, effectType);
                }
            });
            showFeedback('æ¸¬é©—æ¨¡å¼', '#a855f7');
        }

        // Modals
        function showResultModal(score, effectType) {
            const modal = document.getElementById('result-modal');
            const scoreEl = document.getElementById('result-score');
            const starsEl = document.getElementById('result-stars');
            const emojiEl = document.getElementById('result-emoji');
            const titleEl = document.getElementById('result-title');
            
            const streakMsg = document.getElementById('streak-msg');
            const perfectMsg = document.getElementById('perfect-msg');
            
            // Reset state
            streakMsg.classList.add('hidden');
            perfectMsg.classList.add('hidden');
            titleEl.innerText = "æ¸¬é©—å®Œæˆ";

            scoreEl.innerText = score;
            
            let stars = '';
            let emoji = '';
            
            if (score === 100) { stars = 'â­â­â­'; emoji = 'ğŸ†'; }
            else if (score >= 80) { stars = 'â­â­'; emoji = 'ğŸ˜'; }
            else if (score >= 60) { stars = 'â­'; emoji = 'ğŸ™‚'; }
            else { stars = 'ğŸ’ª'; emoji = 'ğŸ’ª'; }

            if (effectType === 'perfect_lesson') {
                emoji = 'ğŸ†';
                perfectMsg.classList.remove('hidden');
                titleEl.innerText = "å®Œç¾é€šé—œï¼";
            } else if (effectType === 'streak_fireworks') {
                emoji = 'ğŸ†'; // Fireworks emoji
                streakMsg.innerText = `ğŸ† é€£çºŒ ${streakCount} æ¬¡ 100 åˆ†ï¼å¤ªå¼·äº†ï¼ ğŸ†`; // Update text/emoji
                streakMsg.classList.remove('hidden');
            }
            
            starsEl.innerHTML = stars;
            emojiEl.innerText = emoji;
            modal.classList.remove('hidden');
        }

        function closeResultModal() {
            document.getElementById('result-modal').classList.add('hidden');
            if(writer) writer.showOutline();
            clearEffects(); // é—œé–‰è¦–çª—æ™‚åœæ­¢ç‰¹æ•ˆ
        }

        function openScoreModal() {
            const modal = document.getElementById('score-modal');
            const list = document.getElementById('score-list');
            list.innerHTML = '';
            
            let hasRecord = false;
            lessonVocab.forEach(item => {
                const char = getChar(item);
                const score = scoreHistory[char];
                if (score !== undefined) {
                    hasRecord = true;
                    let color = score === 100 ? 'text-green-600' : (score >= 60 ? 'text-blue-600' : 'text-red-500');
                    const div = document.createElement('div');
                    div.className = `flex justify-between p-3 border-b items-center`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-2xl char-font font-bold">${char}</span>
                            <span class="text-xs text-gray-500">${item.pinyin || ''}</span>
                        </div>
                        <div class="font-bold ${color}">${score}åˆ†</div>
                    `;
                    list.appendChild(div);
                }
            });
            
            if (!hasRecord) list.innerHTML = '<div class="text-center text-gray-400 py-4">æš«ç„¡ç´€éŒ„</div>';
            modal.classList.remove('hidden');
        }

        function closeScoreModal() {
            document.getElementById('score-modal').classList.add('hidden');
        }

        // --- Custom Input Logic ---
        function openCustomModal() {
            document.getElementById('custom-modal').classList.remove('hidden');
            // åœ¨è‡ªè¨‚æ¨¡å¼ä¸‹ï¼Œè‹¥ä½¿ç”¨ç¹é«”è¼¸å…¥ï¼Œåˆ‡æ›åˆ°ç°¡é«”æ¨¡å¼ï¼Œç›®å‰ä¸¦ä¸æœƒè‡ªå‹•è½‰æ›å…§å®¹ï¼Œ
            // è€Œæ˜¯ç›´æ¥ä½¿ç”¨è¼¸å…¥çš„å­—ç¬¦ä½œç‚ºç·´ç¿’å°è±¡ã€‚
            const currentChars = customVocab.map(item => item.char).join('');
            document.getElementById('custom-input').value = currentChars;
            document.getElementById('custom-input').focus();
        }

        function closeCustomModal() {
            document.getElementById('custom-modal').classList.add('hidden');
            hideDeleteConfirm(); // Reset delete view
        }

        function saveCustomWords() {
            const text = document.getElementById('custom-input').value;
            const chars = text.match(/[\u4e00-\u9fa5]/g);
            
            if (!chars || chars.length === 0) {
                 if(text.trim() === '') {
                     customVocab = []; 
                 } else {
                     showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¸­æ–‡å­—');
                     return;
                 }
            } else {
                // Initialize converters
                let cn2tw = null;
                let tw2cn = null;
                try {
                    cn2tw = OpenCC.Converter({ from: 'cn', to: 'tw' });
                    tw2cn = OpenCC.Converter({ from: 'tw', to: 'cn' });
                } catch(e) {
                    console.warn("OpenCC init failed", e);
                }

                customVocab = chars.map(char => {
                    let traditional = char;
                    let simplified = char;

                    if (cn2tw && tw2cn) {
                        // Normalize: assume user might type simplified OR traditional
                        // Convert to Traditional first (as base 'char')
                        traditional = cn2tw(char);
                        // Convert that Traditional to Simplified (as 'simp')
                        simplified = tw2cn(traditional);
                    }

                    return {
                        l: 'custom',
                        char: traditional,
                        simp: simplified,
                        pinyin: '',
                        zhuyin: ''
                    };
                });
            }
            
            localStorage.setItem(CUSTOM_VOCAB_KEY, JSON.stringify(customVocab));

            document.getElementById('lesson-select').value = 'custom';
            updateLessonData('custom');
            closeCustomModal();
            showToast('å·²æ›´æ–°è‡ªè¨‚èª²ç¨‹');
        }

        // Custom Delete Logic
        function showDeleteConfirm() {
            document.getElementById('custom-delete-confirm').classList.remove('hidden');
        }

        function hideDeleteConfirm() {
            document.getElementById('custom-delete-confirm').classList.add('hidden');
        }

        function confirmDeleteCustom() {
            customVocab = [];
            localStorage.removeItem(CUSTOM_VOCAB_KEY);
            document.getElementById('custom-input').value = '';
            
            // If currently viewing custom lesson, switch to lesson 1
            if(currentLesson === 'custom') {
                document.getElementById('lesson-select').value = 1;
                updateLessonData(1);
            }
            
            hideDeleteConfirm();
            closeCustomModal();
            showToast('å·²åˆªé™¤è‡ªè¨‚èª²ç¨‹');
        }

        let deferredPrompt;

        function initInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const btn = document.getElementById('install-btn');
                if(btn) btn.classList.remove('hidden');
            });
        }

        function triggerInstall() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                document.getElementById('install-modal').classList.remove('hidden');
            } else if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('install-btn').classList.add('hidden');
                });
            } else {
                alert('è«‹æŒ‰ Ctrl+D (æˆ– Command+D) å°‡æ­¤é é¢åŠ å…¥æ›¸ç±¤ï¼Œæ–¹ä¾¿éš¨æ™‚ç·´ç¿’ï¼');
            }
        }

        function closeInstallModal() {
            document.getElementById('install-modal').classList.add('hidden');
        }

        // --- å­—å…¸æŸ¥è©¢åŠŸèƒ½ (Moedict API) ---
        function closeDictModal() {
            document.getElementById('dict-modal').classList.add('hidden');
        }

        function openOfficialMoe() {
            if (lessonVocab.length === 0) return;
            const item = lessonVocab[currentIndex];
            // è¤‡è£½ç¹é«”å­—ï¼Œå› ç‚ºèŒå…¸æ˜¯å°ç£å­—å…¸
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(item.char);
            }
            window.open('https://dict.mini.moe.edu.tw/', '_blank');
        }

        function showDictionary() {
            if (lessonVocab.length === 0) return;
            const item = lessonVocab[currentIndex];
            // å³ä½¿åœ¨ç°¡é«”æ¨¡å¼ï¼ŒæŸ¥è©¢å­—å…¸æ™‚ä»ä½¿ç”¨ç¹é«”å­— (item.char)
            // å› ç‚ºèŒå…¸ (moedict) è³‡æ–™åº«éµå€¼æ˜¯ç¹é«”
            const char = item.char; 

            const modal = document.getElementById('dict-modal');
            const contentArea = document.getElementById('dict-content-area');
            const loading = document.getElementById('dict-loading');
            
            modal.classList.remove('hidden');
            contentArea.innerHTML = '';
            loading.classList.remove('hidden');

            // Fetch from Moedict API
            fetch(`https://www.moedict.tw/uni/${encodeURIComponent(char)}`)
                .then(res => {
                    if(!res.ok) throw new Error('æŸ¥ç„¡æ­¤å­—');
                    return res.json();
                })
                .then(data => {
                    renderDictData(data);
                })
                .catch(err => {
                    console.error(err);
                    contentArea.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-400 mb-2">å­—å…¸è£¡æ‰¾ä¸åˆ°é€™å€‹å­—</div>
                            <button onclick="openOfficialMoe()" class="text-blue-500 hover:underline">è©¦è©¦æ•™è‚²éƒ¨å°å­—å…¸ â†—</button>
                        </div>
                    `;
                })
                .finally(() => {
                    loading.classList.add('hidden');
                });
        }

        function renderDictData(data) {
            const contentArea = document.getElementById('dict-content-area');
            let html = '';

            if (data.heteronyms) {
                data.heteronyms.forEach((h, index) => {
                    html += `<div class="dict-entry">`;
                    html += `<div class="dict-pronunciation">
                                <span class="dict-zhuyin">${h.bopomofo || ''}</span>
                                <span class="dict-pinyin">${h.pinyin || ''}</span>
                             </div>`;
                    
                    if (h.definitions) {
                        h.definitions.forEach((def, i) => {
                            html += `<div class="dict-def-item">
                                        <div>
                                            <span class="dict-def-num">${i + 1}.</span>
                                            <span class="dict-def-text">${def.def}</span>
                                        </div>`;
                            if (def.example) {
                                def.example.forEach(ex => {
                                    html += `<div class="dict-example">${ex}</div>`;
                                });
                            }
                            html += `</div>`;
                        });
                    }
                    html += `</div>`;
                });
            }

            contentArea.innerHTML = html;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            if(!toast) {
                const div = document.createElement('div');
                div.id = 'toast';
                div.className = 'fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm transition-opacity duration-300 opacity-0 pointer-events-none z-[60]';
                document.body.appendChild(div);
            }
            
            const el = document.getElementById('toast');
            el.innerText = message;
            el.style.opacity = 1;
            setTimeout(() => { el.style.opacity = 0; }, 3000);
        }
    </script>
</body>
</html>