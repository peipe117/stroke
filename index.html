<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¸è¯èªå‘å‰èµ°(äºŒ) - ç­†é †ç·´ç¿’</title>
    <meta name="description" content="æ•¸ä½åŒ–è¯èªç”Ÿå­—ç­†é †ç·´ç¿’å·¥å…·ï¼Œæ”¯æ´è‡ªè¨‚ç”Ÿå­—èˆ‡æ•™è‚²éƒ¨å­—å…¸æŸ¥è©¢ã€‚">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ç­†é †ç·´ç¿’">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1250/1250617.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/1250/1250617.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');

        body { 
            font-family: "TW-Kai", "BiauKai", "DFKai-SB", "KaiTi", "Noto Serif TC", serif; 
            background-color: #f8fafc;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .ui-font { font-family: system-ui, -apple-system, sans-serif; }
        .char-font { font-family: "TW-Kai", "BiauKai", "DFKai-SB", "KaiTi", "Noto Serif TC", serif; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #writer-card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }

        .strip-item {
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }
        .strip-item.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.05);
            z-index: 10;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-bg { transition: opacity 0.3s ease-in-out; }
        .modal-bg.hidden { opacity: 0; pointer-events: none; }
        .modal-bg:not(.hidden) { opacity: 1; pointer-events: auto; }

        .tian-grid-bg {
            background-image: 
                linear-gradient(0deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%),
                linear-gradient(90deg, transparent 49.5%, #e2e8f0 49.5%, #e2e8f0 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            position: relative;
            background-color: #fff;
        }
        .tian-grid-bg::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 2px solid #e2e8f0; border-radius: 12px; pointer-events: none;
        }
        
        #writer-target { position: relative; z-index: 1; }
        
        .data-source-tag {
            font-size: 10px; color: #9ca3af; position: absolute; bottom: 2px; right: 6px;
            pointer-events: none; background: rgba(255,255,255,0.8); padding: 1px 4px;
            border-radius: 4px; font-weight: bold; z-index: 20;
        }

        @keyframes bounce-in {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* å­—å…¸å…§å®¹æ¨£å¼ */
        .dict-entry { border-bottom: 1px solid #f3f4f6; padding-bottom: 1rem; margin-bottom: 1rem; }
        .dict-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .dict-pronunciation { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.5rem; }
        .dict-zhuyin { font-weight: bold; color: #1f2937; font-size: 1.1rem; }
        .dict-pinyin { color: #6b7280; font-size: 0.9rem; font-family: monospace; }
        .dict-def-item { margin-bottom: 0.5rem; }
        .dict-def-num { display: inline-block; width: 1.2em; color: #3b82f6; font-weight: bold; }
        .dict-def-text { color: #374151; line-height: 1.6; }
        .dict-example { color: #6b7280; font-size: 0.9rem; margin-top: 0.2rem; padding-left: 1.2em; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-gray-800">

    <!-- 1. é ‚éƒ¨å°èˆª -->
    <header class="bg-white shadow-sm z-20 flex-none ui-font">
        <div class="max-w-6xl mx-auto px-4 py-2 flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <h1 class="text-lg md:text-xl font-bold tracking-wide flex items-center gap-2 truncate">
                    <span class="text-blue-600 text-xl">âœï¸</span> 
                    <span class="char-font">å­¸è¯èªå‘å‰èµ°(äºŒ)</span>
                </h1>
                
                <div class="flex items-center gap-2">
                    <!-- å®‰è£æŒ‰éˆ• -->
                    <button id="install-btn" onclick="triggerInstall()" class="hidden text-xs bg-pink-50 text-pink-600 px-2 py-1.5 rounded-lg font-bold hover:bg-pink-100 transition flex items-center gap-1">
                        <span>ğŸ“²</span>
                        <span class="hidden sm:inline">å®‰è£</span>
                    </button>
                    <!-- è‡ªè¨‚æŒ‰éˆ• -->
                    <button onclick="openCustomModal()" class="text-sm bg-green-50 text-green-700 px-3 py-1.5 rounded-lg font-bold hover:bg-green-100 transition flex items-center gap-1">
                        <span>â•</span>
                        <span class="hidden sm:inline">è‡ªè¨‚</span>
                    </button>
                    <!-- æˆç¸¾å–® -->
                    <button onclick="openScoreModal()" class="text-sm bg-yellow-50 text-yellow-700 px-3 py-1.5 rounded-lg font-bold hover:bg-yellow-100 transition flex items-center gap-1">
                        <span>ğŸ“Š</span>
                        <span class="hidden sm:inline">æˆç¸¾å–®</span>
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-center gap-2 pb-1">
                <select id="lesson-select" class="bg-gray-50 border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 outline-none flex-1 max-w-[200px]">
                    <!-- JS ç”Ÿæˆ -->
                </select>
            </div>
        </div>
    </header>

    <!-- 2. ä¸­é–“å¯«å­—æ¿å€ -->
    <main id="stage-area" class="flex-grow relative flex flex-col items-center justify-center bg-gray-100 w-full overflow-hidden">
        
        <button onclick="prevChar()" class="hidden md:flex absolute left-8 top-1/2 -translate-y-1/2 w-12 h-12 bg-white rounded-full shadow-md items-center justify-center text-gray-400 hover:text-blue-600 hover:border-blue-400 transition z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>

        <div id="writer-card" class="bg-white rounded-3xl p-4 flex flex-col items-center relative z-0 w-[90%] max-w-[400px]">
            
            <!-- æ‹¼éŸ³æ³¨éŸ³ -->
            <div class="w-full flex justify-between items-end mb-2 px-2 select-none min-h-[2rem]">
                <div class="text-gray-500 font-medium char-font text-xl" id="stage-zhuyin"></div>
                <button onclick="speakCurrentChar()" class="p-2 rounded-full hover:bg-blue-50 text-blue-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                </button>
                <div class="text-blue-500 font-medium char-font text-xl" id="stage-pinyin"></div>
            </div>

            <!-- Writer -->
            <div class="relative w-full aspect-square max-w-[320px] rounded-xl overflow-hidden tian-grid-bg bg-white" id="writer-wrapper">
                <div id="writer-target"></div>
                
                <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden">
                    <div class="loader"></div>
                </div>
                <div id="error-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-10 hidden text-center px-4">
                    <p class="text-red-500 font-bold ui-font mb-1">è¼‰å…¥å¤±æ•—</p>
                    <p class="text-xs text-gray-500 mb-2">è«‹æª¢æŸ¥ç¶²è·¯</p>
                    <button onclick="reloadCurrent()" class="text-xs bg-gray-200 px-2 py-1 rounded ui-font hover:bg-gray-300">é‡è©¦</button>
                </div>
                <div id="feedback-msg" class="absolute bottom-4 left-0 right-0 text-center font-bold text-lg pointer-events-none opacity-0 transition-opacity duration-300 char-font" style="text-shadow: 0 1px 2px rgba(255,255,255,1);"></div>
                <div id="current-best-score" class="absolute top-2 right-2 text-yellow-400 text-2xl filter drop-shadow-sm font-bold opacity-80 pointer-events-none"></div>
                <div id="data-source-tag" class="data-source-tag">TW</div>
            </div>

            <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
            <div class="w-full mt-4 space-y-3 ui-font">
                <!-- ç¬¬ä¸€æ’ï¼šæ ¸å¿ƒç·´ç¿’ -->
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="startAnimation()" class="flex flex-col items-center justify-center py-2.5 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 active:scale-95 transition">
                        <span class="text-xl">ğŸ‘€</span>
                        <span class="text-xs font-bold mt-1">æ¼”ç¤º</span>
                    </button>
                    <button onclick="startPractice()" class="flex flex-col items-center justify-center py-2.5 rounded-xl bg-green-50 text-green-600 hover:bg-green-100 active:scale-95 transition">
                        <span class="text-xl">âœï¸</span>
                        <span class="text-xs font-bold mt-1">ç·´ç¿’</span>
                    </button>
                    <button onclick="startQuiz()" class="flex flex-col items-center justify-center py-2.5 rounded-xl bg-purple-50 text-purple-600 hover:bg-purple-100 active:scale-95 transition">
                        <span class="text-xl">ğŸ’¯</span>
                        <span class="text-xs font-bold mt-1">æ¸¬é©—</span>
                    </button>
                </div>

                <!-- ç¬¬äºŒæ’ï¼šæ•™è‚²éƒ¨å­—å…¸æŒ‰éˆ• -->
                <button onclick="showDictionary()" class="w-full py-3 rounded-xl bg-gradient-to-r from-orange-400 to-red-500 text-white font-bold shadow-md hover:shadow-lg active:scale-98 transition flex items-center justify-center gap-2">
                    <span>ğŸ“–</span>
                    <span>å­—å…¸è§£èªª</span>
                </button>

                <!-- ç¬¬ä¸‰æ’ -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openCustomModal()" class="py-2.5 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 transition flex items-center justify-center gap-2">
                        <span>âœï¸</span> è‡ªè¨‚ç”Ÿå­—
                    </button>
                    <button onclick="openScoreModal()" class="py-2.5 rounded-xl bg-yellow-50 text-yellow-700 font-bold hover:bg-yellow-100 transition flex items-center justify-center gap-2">
                        <span>ğŸ“Š</span> æŸ¥çœ‹æˆç¸¾
                    </button>
                </div>
            </div>

            <div class="md:hidden absolute -bottom-8 text-gray-400 text-xs ui-font flex items-center gap-1 opacity-60">
                <span>â† å·¦å³æ»‘å‹•æ›å­— â†’</span>
            </div>
        </div>

        <button onclick="nextChar()" class="hidden md:flex absolute right-8 top-1/2 -translate-y-1/2 w-12 h-12 bg-white rounded-full shadow-md items-center justify-center text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
        </button>

    </main>

    <!-- 3. åº•éƒ¨é¸å–® -->
    <footer class="bg-white border-t border-gray-200 flex-none h-32 w-full z-20">
        <div class="h-full w-full max-w-6xl mx-auto p-3">
            <div id="character-strip" class="flex items-center gap-3 overflow-x-auto h-full px-2 no-scrollbar scroll-smooth pb-2">
                <!-- JS ç”Ÿæˆ -->
            </div>
        </div>
    </footer>

    <!-- ä¿®è¨‚è€…ç°½å -->
    <div class="flex-none bg-gray-50 text-center py-1 text-[10px] text-gray-400 ui-font border-t border-gray-100">
        Sophia Wong ä¿®è¨‚
    </div>

    <!-- 4. æ¸¬é©—çµæœå½ˆçª— -->
    <div id="result-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-[85%] max-w-sm shadow-2xl transform scale-100 transition-transform duration-300 flex flex-col items-center animate-bounce-in">
            <div class="text-5xl mb-3 animate-bounce" id="result-emoji">ğŸ‰</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-1 ui-font">æ¸¬é©—å®Œæˆ</h3>
            <div class="flex gap-2 my-2 text-3xl text-yellow-400 filter drop-shadow-sm" id="result-stars"></div>
            <div class="text-gray-600 ui-font mb-6 text-center bg-gray-50 px-6 py-2 rounded-xl mt-2 w-full">
                <div class="text-xs text-gray-400 mb-1">æœ¬æ¬¡å¾—åˆ†</div>
                <span id="result-score" class="text-4xl font-bold text-blue-600">--</span>
                <span class="text-sm font-medium">åˆ†</span>
            </div>
            <button onclick="closeResultModal()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white rounded-xl font-bold shadow-lg transition ui-font flex items-center justify-center gap-2">
                <span>ç¹¼çºŒç·´ç¿’</span>
            </button>
        </div>
    </div>

    <!-- 5. æˆç¸¾å–®å½ˆçª— -->
    <div id="score-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-0 w-[90%] max-w-md shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
            <div class="p-4 border-b bg-yellow-50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-yellow-800 flex items-center gap-2 ui-font">
                    <span>ğŸ“Š</span> å­¸ç¿’æˆç¸¾å–®
                </h3>
                <button onclick="closeScoreModal()" class="text-gray-400 hover:text-gray-600 p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto bg-white flex-grow ui-font">
                <div id="score-list" class="space-y-3"></div>
                <div id="no-score-msg" class="hidden text-center text-gray-400 py-8">
                    <div class="text-4xl mb-2">ğŸ“</div>
                    <p>é‚„æ²’æœ‰æ¸¬é©—ç´€éŒ„å–”ï¼<br>è¶•å¿«å»ç·´ç¿’å§ï¼</p>
                </div>
            </div>
            <div class="p-4 border-t bg-gray-50 text-center text-xs text-gray-400">
                ç´€éŒ„å·²è‡ªå‹•å„²å­˜æ–¼æ­¤è£ç½®
            </div>
        </div>
    </div>

    <!-- 6. å­—å…¸è§£èªªå½ˆçª— -->
    <div id="dict-modal" class="modal-bg fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-t-3xl md:rounded-3xl p-6 w-full md:w-[90%] max-w-md shadow-2xl transform transition-transform duration-300 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 ui-font">
                    <span class="text-2xl">ğŸ“–</span> å­—å…¸è§£èªª
                </h3>
                <button onclick="closeDictModal()" class="text-gray-400 hover:text-gray-600 p-2 bg-gray-100 rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="dict-content-area" class="overflow-y-auto pr-2 ui-font text-base text-gray-700 dict-content flex-grow">
                <!-- å­—å…¸å…§å®¹ -->
            </div>
            <div id="dict-loading" class="flex flex-col items-center justify-center py-8">
                <div class="loader mb-3"></div>
                <p class="text-sm text-gray-500 animate-pulse">æ­£åœ¨æŸ¥è©¢å­—å…¸...</p>
            </div>
            
            <div class="mt-4 pt-3 border-t flex justify-between items-center text-xs text-gray-400">
                <span>è³‡æ–™ä¾†æºï¼šèŒå…¸ (æ•™è‚²éƒ¨é‡ç·¨åœ‹èªè¾­å…¸)</span>
                <button onclick="openOfficialMoe()" class="text-blue-500 hover:underline">å‰å¾€æ•™è‚²éƒ¨å°å­—å…¸ â†—</button>
            </div>
        </div>
    </div>

    <!-- 7. è‡ªè¨‚ç”Ÿå­— Modal -->
    <div id="custom-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-[90%] max-w-sm shadow-2xl p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 ui-font flex items-center gap-2">
                <span>âœï¸</span> è‡ªè¨‚ç·´ç¿’ç”Ÿå­—
            </h3>
            <p class="text-sm text-gray-500 mb-2 ui-font">è«‹è¼¸å…¥æ‚¨æƒ³ç·´ç¿’çš„æ¼¢å­—ï¼ˆå¯éš¨æ™‚ä¿®æ”¹ï¼‰ï¼š</p>
            <textarea id="custom-input" rows="4" class="w-full border border-gray-300 rounded-xl p-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none char-font text-xl resize-none placeholder-gray-400 text-gray-900 bg-white" placeholder="ä¾‹å¦‚ï¼šæ–°å¹´å¿«æ¨‚"></textarea>
            
            <div class="flex gap-3">
                <button onclick="closeCustomModal()" class="flex-1 py-2.5 rounded-xl border border-gray-300 text-gray-600 font-bold hover:bg-gray-50 transition ui-font">å–æ¶ˆ</button>
                <button onclick="saveCustomWords()" class="flex-1 py-2.5 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-md transition ui-font">é–‹å§‹ç·´ç¿’</button>
            </div>
        </div>
    </div>

    <!-- 8. å®‰è£æ•™å­¸ Modal -->
    <div id="install-modal" class="modal-bg fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-[85%] max-w-xs shadow-2xl flex flex-col items-center text-center animate-bounce-in">
            <h3 class="text-lg font-bold text-gray-800 mb-3 ui-font">åŠ å…¥ä¸»ç•«é¢</h3>
            <p class="text-sm text-gray-600 mb-4 ui-font leading-relaxed">
                å°‡æ­¤ç¶²é åŠ å…¥ä¸»ç•«é¢ï¼Œå³å¯åƒ App ä¸€æ¨£å…¨è¢å¹•ç·´ç¿’ï¼
            </p>
            <div class="bg-gray-100 rounded-lg p-3 text-sm text-gray-700 w-full mb-4 text-left ui-font">
                1. é»æ“Šä¸‹æ–¹çš„ <span class="font-bold text-blue-600">åˆ†äº«</span> æŒ‰éˆ• <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg><br>
                2. å¾€ä¸‹æ»‘æ‰¾åˆ° <span class="font-bold">ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</span><br>
                3. é»æ“Šå³ä¸Šè§’çš„ <span class="font-bold">ã€Œæ–°å¢ã€</span>
            </div>
            <button onclick="closeInstallModal()" class="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition ui-font">çŸ¥é“äº†</button>
        </div>
    </div>

    <script>
        // è³‡æ–™åº«
        const vocabulary = [
            // ç¬¬ä¸€èª²
            { l: 1, char: 'æ–°', pinyin: 'xÄ«n', zhuyin: 'ã„’ã„§ã„£' },
            { l: 1, char: 'åŒ', pinyin: 'tÃ³ng', zhuyin: 'ã„Šã„¨ã„¥ËŠ' },
            { l: 1, char: 'å­¸', pinyin: 'xuÃ©', zhuyin: 'ã„’ã„©ã„ËŠ' },
            { l: 1, char: 'è‡ª', pinyin: 'zÃ¬', zhuyin: 'ã„—Ë‹' },
            { l: 1, char: 'å·±', pinyin: 'jÇ', zhuyin: 'ã„ã„§Ë‡' },
            { l: 1, char: 'å¹´', pinyin: 'niÃ¡n', zhuyin: 'ã„‹ã„§ã„¢ËŠ' },
            { l: 1, char: 'è·Ÿ', pinyin: 'gÄ“n', zhuyin: 'ã„ã„£' },
            { l: 1, char: 'æ¯”', pinyin: 'bÇ', zhuyin: 'ã„…ã„§Ë‡' },
            // ç¬¬äºŒèª²
            { l: 2, char: 'å¤–', pinyin: 'wÃ i', zhuyin: 'ã„¨ã„Ë‹' },
            { l: 2, char: 'å…¬', pinyin: 'gÅng', zhuyin: 'ã„ã„¨ã„¥' },
            { l: 2, char: 'ä»¥', pinyin: 'yÇ', zhuyin: 'ã„§Ë‡' },
            { l: 2, char: 'å‰', pinyin: 'qiÃ¡n', zhuyin: 'ã„‘ã„§ã„¢ËŠ' },
            { l: 2, char: 'å·¥', pinyin: 'gÅng', zhuyin: 'ã„ã„¨ã„¥' },
            { l: 2, char: 'ä½œ', pinyin: 'zuÃ²', zhuyin: 'ã„—ã„¨ã„›Ë‹' },
            { l: 2, char: 'ç­', pinyin: 'bÄn', zhuyin: 'ã„…ã„¢' },
            { l: 2, char: 'å¾Œ', pinyin: 'hÃ²u', zhuyin: 'ã„ã„¡Ë‹' },
            // ç¬¬ä¸‰èª²
            { l: 3, char: 'å»', pinyin: 'qÃ¹', zhuyin: 'ã„‘ã„©Ë‹' },
            { l: 3, char: 'è¿‘', pinyin: 'jÃ¬n', zhuyin: 'ã„ã„§ã„£Ë‹' },
            { l: 3, char: 'è²·', pinyin: 'mÇi', zhuyin: 'ã„‡ã„Ë‡' },
            { l: 3, char: 'æ±', pinyin: 'dÅng', zhuyin: 'ã„‰ã„¨ã„¥' },
            { l: 3, char: 'è¥¿', pinyin: 'xÄ«', zhuyin: 'ã„’ã„§' },
            { l: 3, char: 'é­š', pinyin: 'yÃº', zhuyin: 'ã„©ËŠ' },
            { l: 3, char: 'é‚„', pinyin: 'hÃ¡i', zhuyin: 'ã„ã„ËŠ' },
            { l: 3, char: 'å¯', pinyin: 'kÄ›', zhuyin: 'ã„ã„œË‡' },
            // ç¬¬å››èª²
            { l: 4, char: 'å‡º', pinyin: 'chÅ«', zhuyin: 'ã„”ã„¨' },
            { l: 4, char: 'å…ˆ', pinyin: 'xiÄn', zhuyin: 'ã„’ã„§ã„¢' },
            { l: 4, char: 'é€±', pinyin: 'zhÅu', zhuyin: 'ã„“ã„¡' },
            { l: 4, char: 'æœ«', pinyin: 'mÃ²', zhuyin: 'ã„‡ã„›Ë‹' },
            { l: 4, char: 'æ™š', pinyin: 'wÇn', zhuyin: 'ã„¨ã„¢Ë‡' },
            { l: 4, char: 'è›‹', pinyin: 'dÃ n', zhuyin: 'ã„‰ã„¢Ë‹' },
            { l: 4, char: 'é£¯', pinyin: 'fÃ n', zhuyin: 'ã„ˆã„¢Ë‹' },
            { l: 4, char: 'ç¾', pinyin: 'xiÃ n', zhuyin: 'ã„’ã„§ã„¢Ë‹' },
            { l: 4, char: 'é»', pinyin: 'diÇn', zhuyin: 'ã„‰ã„§ã„¢Ë‡' },
            // ç¬¬äº”èª²
            { l: 5, char: 'é»ƒ', pinyin: 'huÃ¡ng', zhuyin: 'ã„ã„¨ã„¤ËŠ' },
            { l: 5, char: 'ç¶ ', pinyin: 'lÇœ', zhuyin: 'ã„Œã„©Ë‹' },
            { l: 5, char: 'è‰²', pinyin: 'sÃ¨', zhuyin: 'ã„™ã„œË‹' },
            { l: 5, char: 'æ™‚', pinyin: 'shÃ­', zhuyin: 'ã„•ËŠ' },
            { l: 5, char: 'å€™', pinyin: 'hÃ²u', zhuyin: 'ã„ã„¡Ë‹' },
            { l: 5, char: 'èŠ±', pinyin: 'huÄ', zhuyin: 'ã„ã„¨ã„š' },
            { l: 5, char: 'å­', pinyin: 'zi', zhuyin: 'Ë™ã„—' },
            { l: 5, char: 'ç´…', pinyin: 'hÃ³ng', zhuyin: 'ã„ã„¨ã„¥ËŠ' },
            { l: 5, char: 'ç™½', pinyin: 'bÃ¡i', zhuyin: 'ã„…ã„ËŠ' },
            // ç¬¬å…­èª²
            { l: 6, char: 'èªª', pinyin: 'shuÅ', zhuyin: 'ã„•ã„¨ã„›' },
            { l: 6, char: 'å°', pinyin: 'duÃ¬', zhuyin: 'ã„‰ã„¨ã„ŸË‹' },
            { l: 6, char: 'æ˜Ÿ', pinyin: 'xÄ«ng', zhuyin: 'ã„’ã„§ã„¥' },
            { l: 6, char: 'æœŸ', pinyin: 'qÃ­', zhuyin: 'ã„‘ã„§ËŠ' },
            { l: 6, char: 'æœƒ', pinyin: 'huÃ¬', zhuyin: 'ã„ã„¨ã„ŸË‹' },
            { l: 6, char: 'æ¯', pinyin: 'mÄ›i', zhuyin: 'ã„‡ã„ŸË‡' },
            { l: 6, char: 'çµ¦', pinyin: 'gÄ›i', zhuyin: 'ã„ã„ŸË‡' },
            { l: 6, char: 'å¦‚', pinyin: 'ã„–ã„¨ËŠ', zhuyin: 'ã„–ã„¨ËŠ' },
            { l: 6, char: 'æœ', pinyin: 'guÇ’', zhuyin: 'ã„ã„¨ã„›Ë‡' },
            // ç¬¬ä¸ƒèª²
            { l: 7, char: 'èµ·', pinyin: 'qÇ', zhuyin: 'ã„‘ã„§Ë‡' },
            { l: 7, char: 'ç´¯', pinyin: 'lÃ¨i', zhuyin: 'ã„Œã„ŸË‹' },
            { l: 7, char: 'æ—©', pinyin: 'zÇo', zhuyin: 'ã„—ã„ Ë‡' },
            { l: 7, char: 'æ´—', pinyin: 'xÇ', zhuyin: 'ã„’ã„§Ë‡' },
            { l: 7, char: 'æ˜¨', pinyin: 'zuÃ³', zhuyin: 'ã„—ã„¨ã„›ËŠ' },
            { l: 7, char: 'é', pinyin: 'guÃ²', zhuyin: 'ã„ã„¨ã„›Ë‹' },
            { l: 7, char: 'åˆ¥', pinyin: 'biÃ©', zhuyin: 'ã„…ã„§ã„ËŠ' },
            { l: 7, char: 'å¿˜', pinyin: 'wÃ ng', zhuyin: 'ã„¨ã„¤Ë‹' },
            { l: 7, char: 'ç”¨', pinyin: 'yÃ²ng', zhuyin: 'ã„©ã„¥Ë‹' },
            { l: 7, char: 'è‡‰', pinyin: 'liÇn', zhuyin: 'ã„Œã„§ã„¢Ë‡' },
            // ç¬¬å…«èª²
            { l: 8, char: 'é€', pinyin: 'sÃ²ng', zhuyin: 'ã„™ã„¨ã„¥Ë‹' },
            { l: 8, char: 'éš»', pinyin: 'zhÄ«', zhuyin: 'ã„“' },
            { l: 8, char: 'ç‹—', pinyin: 'gÇ’u', zhuyin: 'ã„ã„¡Ë‡' },
            { l: 8, char: 'å¸¶', pinyin: 'dÃ i', zhuyin: 'ã„‰ã„Ë‹' },
            { l: 8, char: 'æ•£', pinyin: 'sÃ n', zhuyin: 'ã„™ã„¢Ë‹' },
            { l: 8, char: 'æ­¥', pinyin: 'bÃ¹', zhuyin: 'ã„…ã„¨Ë‹' },
            { l: 8, char: 'è²“', pinyin: 'mÄo', zhuyin: 'ã„‡ã„ ' },
            { l: 8, char: 'é', pinyin: 'fÄ“i', zhuyin: 'ã„ˆã„Ÿ' },
            { l: 8, char: 'æ„›', pinyin: 'Ã i', zhuyin: 'ã„Ë‹' },
            // ç¬¬ä¹èª²
            { l: 9, char: 'å—', pinyin: 'nÃ¡n', zhuyin: 'ã„‹ã„¢ËŠ' },
            { l: 9, char: 'åŒ—', pinyin: 'bÄ›i', zhuyin: 'ã„…ã„ŸË‡' },
            { l: 9, char: 'æ–¹', pinyin: 'fÄng', zhuyin: 'ã„ˆã„¤' },
            { l: 9, char: 'è£¡', pinyin: 'lÇ', zhuyin: 'ã„Œã„§Ë‡' },
            { l: 9, char: 'æ ¡', pinyin: 'xiÃ o', zhuyin: 'ã„’ã„§ã„ Ë‹' },
            { l: 9, char: 'é–€', pinyin: 'mÃ©n', zhuyin: 'ã„‡ã„£ËŠ' },
            { l: 9, char: 'å£', pinyin: 'kÇ’u', zhuyin: 'ã„ã„¡Ë‡' },
            { l: 9, char: 'å› ', pinyin: 'yÄ«n', zhuyin: 'ã„§ã„£' },
            { l: 9, char: 'ç‚º', pinyin: 'wÃ¨i', zhuyin: 'ã„¨ã„ŸË‹' },
            { l: 9, char: 'æ‰€', pinyin: 'suÇ’', zhuyin: 'ã„™ã„¨ã„›Ë‡' },
            // ç¬¬åèª²
            { l: 10, char: 'æœ¬', pinyin: 'bÄ›n', zhuyin: 'ã„…ã„£Ë‡' },
            { l: 10, char: 'è‘—', pinyin: 'zhe', zhuyin: 'Ë™ã„“ã„œ' },
            { l: 10, char: 'é€€', pinyin: 'tuÃ¬', zhuyin: 'ã„Šã„¨ã„ŸË‹' },
            { l: 10, char: 'ä¼‘', pinyin: 'xiÅ«', zhuyin: 'ã„’ã„§ã„¡' },
            { l: 10, char: 'æ¬¡', pinyin: 'cÃ¬', zhuyin: 'ã„˜Ë‹' },
            { l: 10, char: 'æ—…', pinyin: 'lÇš', zhuyin: 'ã„Œã„©Ë‡' },
            { l: 10, char: 'è¡Œ', pinyin: 'xÃ­ng', zhuyin: 'ã„’ã„§ã„¥ËŠ' },
            { l: 10, char: 'æ³•', pinyin: 'fÇ', zhuyin: 'ã„ˆã„šË‡' },
            { l: 10, char: 'åœ‹', pinyin: 'guÃ³', zhuyin: 'ã„ã„¨ã„›ËŠ' },
            // ç¬¬åä¸€èª²
            { l: 11, char: 'å‹•', pinyin: 'dÃ²ng', zhuyin: 'ã„‰ã„¨ã„¥Ë‹' },
            { l: 11, char: 'ç‰©', pinyin: 'wÃ¹', zhuyin: 'ã„¨Ë‹' },
            { l: 11, char: 'åœ’', pinyin: 'yuÃ¡n', zhuyin: 'ã„©ã„¢ËŠ' },
            { l: 11, char: 'è€', pinyin: 'lÇo', zhuyin: 'ã„Œã„ Ë‡' },
            { l: 11, char: 'å¸Œ', pinyin: 'xÄ«', zhuyin: 'ã„’ã„§' },
            { l: 11, char: 'æœ›', pinyin: 'wÃ ng', zhuyin: 'ã„¨ã„¤Ë‹' },
            { l: 11, char: 'ä½†', pinyin: 'dÃ n', zhuyin: 'ã„‰ã„¢Ë‹' },
            { l: 11, char: 'èƒ–', pinyin: 'pÃ ng', zhuyin: 'ã„†ã„¤Ë‹' },
            { l: 11, char: 'çœŸ', pinyin: 'zhÄ“n', zhuyin: 'ã„“ã„£' },
            { l: 11, char: 'é•·', pinyin: 'chÃ¡ng', zhuyin: 'ã„”ã„¤ËŠ' },
            // ç¬¬åäºŒèª²
            { l: 12, char: 'ä¹…', pinyin: 'jiÇ”', zhuyin: 'ã„ã„§ã„¡Ë‡' },
            { l: 12, char: 'è©±', pinyin: 'huÃ ', zhuyin: 'ã„ã„¨ã„šË‹' },
            { l: 12, char: 'é«˜', pinyin: 'gÄo', zhuyin: 'ã„ã„ ' },
            { l: 12, char: 'èª²', pinyin: 'kÃ¨', zhuyin: 'ã„ã„œË‹' },
            { l: 12, char: 'å¯«', pinyin: 'xiÄ›', zhuyin: 'ã„’ã„§ã„Ë‡' },
            { l: 12, char: 'æ²’', pinyin: 'mÃ©i', zhuyin: 'ã„‡ã„ŸËŠ' },
            { l: 12, char: 'é¡Œ', pinyin: 'tÃ­', zhuyin: 'ã„Šã„§ËŠ' },
            { l: 12, char: 'å®š', pinyin: 'dÃ¬ng', zhuyin: 'ã„‰ã„§ã„¥Ë‹' },
            { l: 12, char: 'æ„', pinyin: 'yÃ¬', zhuyin: 'ã„§Ë‹' },
            { l: 12, char: 'æ€', pinyin: 'sÄ«', zhuyin: 'ã„™' }
        ];

        let writer = null;
        let currentLesson = 1;
        let lessonVocab = [];
        let customVocab = []; 
        let currentIndex = 0;
        const SCORE_KEY = 'hanzi_learning_scores_v2';
        const CUSTOM_VOCAB_KEY = 'hanzi_learning_custom_vocab'; 
        let scoreHistory = {};

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadScores();
            loadCustomVocab();
            initLessonSelect();
            updateLessonData(1);
            setupTouchEvents();
            setupKeyboardEvents();
            initInstallPrompt();
        });

        // --- Logic ---
        function loadScores() {
            try {
                const stored = localStorage.getItem(SCORE_KEY);
                if (stored) scoreHistory = JSON.parse(stored);
            } catch (e) { console.error(e); }
        }
        
        function loadCustomVocab() {
            try {
                const stored = localStorage.getItem(CUSTOM_VOCAB_KEY);
                if (stored) customVocab = JSON.parse(stored);
            } catch (e) { console.error(e); }
        }

        function saveScore(char, score) {
            const currentBest = scoreHistory[char] || 0;
            if (score > currentBest) {
                scoreHistory[char] = score;
                localStorage.setItem(SCORE_KEY, JSON.stringify(scoreHistory));
            }
        }

        function getStars(score) {
            if (score === 100) return 'â­â­â­';
            if (score >= 80) return 'â­â­';
            if (score >= 60) return 'â­';
            return '';
        }

        function initLessonSelect() {
            const select = document.getElementById('lesson-select');
            select.innerHTML = ''; 
            
            for(let i=1; i<=12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `ç¬¬ ${i} èª²`;
                select.appendChild(opt);
            }
            
            const customOpt = document.createElement('option');
            customOpt.value = 'custom';
            customOpt.innerText = 'âœ¨ è‡ªè¨‚èª²ç¨‹';
            select.appendChild(customOpt);

            select.addEventListener('change', (e) => {
                const val = e.target.value;
                updateLessonData(val === 'custom' ? 'custom' : parseInt(val));
            });
        }

        function updateLessonData(lesson) {
            currentLesson = lesson;
            
            if (lesson === 'custom') {
                lessonVocab = customVocab;
            } else {
                lessonVocab = vocabulary.filter(item => item.l === currentLesson);
            }
            
            currentIndex = 0;
            renderStrip();
            renderStage();
        }

        function renderStrip() {
            const strip = document.getElementById('character-strip');
            strip.innerHTML = '';
            
            if (lessonVocab.length === 0 && currentLesson === 'custom') {
                strip.innerHTML = `<div class="flex items-center justify-center w-full text-gray-400 text-sm h-full">å°šæœªåŠ å…¥è‡ªè¨‚å­—ï¼Œè«‹é»æ“Šä¸Šæ–¹ã€Œè‡ªè¨‚ã€æŒ‰éˆ•</div>`;
                return;
            }
            
            lessonVocab.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = `strip-item flex-none w-20 h-24 bg-white rounded-xl flex flex-col items-center justify-center cursor-pointer border hover:border-blue-300 shadow-sm ${idx === currentIndex ? 'active ring-2 ring-blue-400' : ''}`;
                div.onclick = () => {
                    currentIndex = idx;
                    renderStripHighlight();
                    renderStage();
                };

                const score = scoreHistory[item.char];
                const stars = score ? getStars(score) : '';
                const starHtml = stars ? `<div class="text-[8px] text-yellow-500 absolute top-1 right-1 leading-none">${stars}</div>` : '';

                const pinyinDisplay = item.pinyin ? item.pinyin : '';
                const zhuyinDisplay = item.zhuyin ? item.zhuyin : '';

                div.innerHTML = `
                    ${starHtml}
                    <div class="text-xs text-gray-400 ui-font mb-1">${zhuyinDisplay}</div>
                    <div class="text-3xl char-font leading-none text-gray-800">${item.char}</div>
                    <div class="text-[10px] text-blue-500 ui-font mt-1 font-semibold">${pinyinDisplay}</div>
                `;
                strip.appendChild(div);
            });
            scrollToActiveStrip();
        }

        function renderStripHighlight() {
            const items = document.querySelectorAll('.strip-item');
            items.forEach((item, idx) => {
                if (idx === currentIndex) item.classList.add('active', 'ring-2', 'ring-blue-400');
                else item.classList.remove('active', 'ring-2', 'ring-blue-400');
            });
            scrollToActiveStrip();
        }

        function scrollToActiveStrip() {
            const strip = document.getElementById('character-strip');
            const activeEl = strip.children[currentIndex];
            if (activeEl) {
                activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        function renderStage() {
            if (lessonVocab.length === 0) {
                document.getElementById('writer-target').innerHTML = '';
                document.getElementById('stage-zhuyin').innerText = '';
                document.getElementById('stage-pinyin').innerText = '';
                return;
            }
            
            const item = lessonVocab[currentIndex];

            document.getElementById('stage-zhuyin').innerText = item.zhuyin || '';
            document.getElementById('stage-pinyin').innerText = item.pinyin || '';

            const target = document.getElementById('writer-target');
            target.innerHTML = '';
            
            document.getElementById('feedback-msg').style.opacity = 0;
            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('data-source-tag').innerText = '';
            
            const bestScore = scoreHistory[item.char];
            const bestEl = document.getElementById('current-best-score');
            bestEl.innerText = bestScore ? `${bestScore}` : '';

            const wrapper = document.getElementById('writer-wrapper');
            const wrapperWidth = wrapper.clientWidth || 300; 
            const size = Math.min(wrapperWidth, 320);
            
            target.style.width = `${size}px`;
            target.style.height = `${size}px`;

            try {
                writer = HanziWriter.create('writer-target', item.char, {
                    width: size,
                    height: size,
                    padding: 10,
                    showOutline: true,
                    strokeAnimationSpeed: 1,
                    delayBetweenStrokes: 400,
                    radicalColor: '#3b82f6', // blue-500
                    strokeColor: '#334155',  // slate-700
                    outlineColor: '#cbd5e1', // slate-300
                    
                    onLoadCharDataSuccess: function() {
                        document.getElementById('loading-indicator').classList.add('hidden');
                        writer.animateCharacter();
                        setTimeout(speakCurrentChar, 300);
                    },
                    onLoadCharDataError: function(err) {
                        document.getElementById('loading-indicator').classList.add('hidden');
                        document.getElementById('error-msg').classList.remove('hidden');
                    },
                    charDataLoader: function(char, onComplete, onError) {
                        const encodedChar = encodeURIComponent(char);
                        
                        const urlTraditional = `https://cdn.jsdelivr.net/gh/Artex/hanzi-writer-data-traditional@master/data/${encodedChar}.json`;
                        const urlStandard = `https://cdn.jsdelivr.net/npm/hanzi-writer-data@2.0/${encodedChar}.json`;

                        fetch(urlTraditional)
                            .then(res => {
                                if (!res.ok) throw new Error('TW fail');
                                return res.json();
                            })
                            .then(json => {
                                document.getElementById('data-source-tag').innerText = 'TW';
                                onComplete(json);
                            })
                            .catch(() => {
                                console.warn(`Switching to standard data for: ${char}`);
                                fetch(urlStandard)
                                    .then(res => res.json())
                                    .then(json => {
                                        document.getElementById('data-source-tag').innerText = 'STD';
                                        onComplete(json);
                                    })
                                    .catch(err => {
                                        console.error('Fatal: All sources failed', err);
                                        document.getElementById('loading-indicator').classList.add('hidden');
                                        document.getElementById('error-msg').classList.remove('hidden');
                                    });
                            });
                    }
                });
            } catch(e) {
                console.error(e);
            }
        }

        function reloadCurrent() {
            renderStage();
        }

        function prevChar() {
            if (currentIndex > 0) {
                currentIndex--;
                renderStripHighlight();
                renderStage();
            }
        }

        function nextChar() {
            if (currentIndex < lessonVocab.length - 1) {
                currentIndex++;
                renderStripHighlight();
                renderStage();
            }
        }

        // Input Handling
        function setupTouchEvents() {
            const area = document.getElementById('stage-area');
            let touchStartX = 0;
            let touchEndX = 0;

            area.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});

            area.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});

            function handleSwipe() {
                const threshold = 50;
                if (touchEndX < touchStartX - threshold) nextChar();
                if (touchEndX > touchStartX + threshold) prevChar();
            }
        }
        
        function setupKeyboardEvents() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') prevChar();
                if (e.key === 'ArrowRight') nextChar();
            });
        }

        // Actions
        function speakCurrentChar() {
            if (lessonVocab.length === 0) return;
            const item = lessonVocab[currentIndex];
            window.speechSynthesis.cancel();
            
            const u = new SpeechSynthesisUtterance(item.char);
            u.lang = 'zh-TW';
            u.rate = 0.8;
            window.speechSynthesis.speak(u);
        }

        function showFeedback(text, color) {
            const el = document.getElementById('feedback-msg');
            el.innerText = text;
            el.style.color = color;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 1500);
        }

        function startAnimation() {
            if(!writer) return;
            speakCurrentChar();
            writer.showOutline();
            writer.animateCharacter();
            showFeedback('æ¼”ç¤ºç­†é †', '#3b82f6');
        }

        function startPractice() {
            if(!writer) return;
            speakCurrentChar();
            writer.showOutline();
            writer.quiz({
                onMistake: () => showFeedback('åŠ æ²¹ï¼', '#ef4444'),
                onCorrectStroke: () => showFeedback('å¾ˆå¥½ï¼', '#22c55e'),
                onComplete: () => showFeedback('å®Œæˆï¼', '#22c55e')
            });
            showFeedback('é–‹å§‹ç·´ç¿’', '#22c55e');
        }

        function triggerConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

            function randomInOut(min, max) {
              return Math.random() * (max - min) + min;
            }

            var interval = setInterval(function() {
              var timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                return clearInterval(interval);
              }

              var particleCount = 50 * (timeLeft / duration);
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInOut(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        function startQuiz() {
            if(!writer) return;
            speakCurrentChar();
            writer.hideOutline();

            writer.quiz({
                onMistake: function(strokeData) {
                    showFeedback('åŠ æ²¹ï¼', '#ef4444');
                    writer.showOutline();
                    setTimeout(() => writer.hideOutline(), 500);
                },
                onComplete: function(summaryData) {
                    const mistakes = summaryData.totalMistakes;
                    const score = Math.max(0, 100 - (mistakes * 10));
                    const item = lessonVocab[currentIndex];
                    saveScore(item.char, score);
                    
                    const isPerfectLesson = lessonVocab.every(word => (scoreHistory[word.char] || 0) === 100);

                    renderStrip(); 
                    showResultModal(score);
                    
                    if (score === 100 && isPerfectLesson) {
                        setTimeout(() => { triggerConfetti(); }, 500);
                    }
                }
            });
            showFeedback('æ¸¬é©—æ¨¡å¼', '#a855f7');
        }

        // Modals
        function showResultModal(score) {
            const modal = document.getElementById('result-modal');
            const scoreEl = document.getElementById('result-score');
            const starsEl = document.getElementById('result-stars');
            const emojiEl = document.getElementById('result-emoji');
            
            scoreEl.innerText = score;
            
            let stars = '';
            let emoji = '';
            
            if (score === 100) { stars = 'â­â­â­'; emoji = 'ğŸ†'; }
            else if (score >= 80) { stars = 'â­â­'; emoji = 'ğŸ˜'; }
            else if (score >= 60) { stars = 'â­'; emoji = 'ğŸ™‚'; }
            else { stars = 'ğŸ’ª'; emoji = 'ğŸ’ª'; }
            
            starsEl.innerHTML = stars;
            emojiEl.innerText = emoji;
            modal.classList.remove('hidden');
        }

        function closeResultModal() {
            document.getElementById('result-modal').classList.add('hidden');
            if(writer) writer.showOutline();
        }

        function openScoreModal() {
            const modal = document.getElementById('score-modal');
            const list = document.getElementById('score-list');
            list.innerHTML = '';
            
            let hasRecord = false;
            lessonVocab.forEach(item => {
                const score = scoreHistory[item.char];
                if (score !== undefined) {
                    hasRecord = true;
                    let color = score === 100 ? 'text-green-600' : (score >= 60 ? 'text-blue-600' : 'text-red-500');
                    const div = document.createElement('div');
                    div.className = `flex justify-between p-3 border-b items-center`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="text-2xl char-font font-bold">${item.char}</span>
                            <span class="text-xs text-gray-500">${item.pinyin || ''}</span>
                        </div>
                        <div class="font-bold ${color}">${score}åˆ†</div>
                    `;
                    list.appendChild(div);
                }
            });
            
            if (!hasRecord) list.innerHTML = '<div class="text-center text-gray-400 py-4">æš«ç„¡ç´€éŒ„</div>';
            modal.classList.remove('hidden');
        }

        function closeScoreModal() {
            document.getElementById('score-modal').classList.add('hidden');
        }

        function openCustomModal() {
            document.getElementById('custom-modal').classList.remove('hidden');
            const currentChars = customVocab.map(item => item.char).join('');
            document.getElementById('custom-input').value = currentChars;
            document.getElementById('custom-input').focus();
        }

        function closeCustomModal() {
            document.getElementById('custom-modal').classList.add('hidden');
        }

        function saveCustomWords() {
            const text = document.getElementById('custom-input').value;
            const chars = text.match(/[\u4e00-\u9fa5]/g);
            
            if (!chars || chars.length === 0) {
                 if(text.trim() === '') {
                     customVocab = []; 
                 } else {
                     alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ä¸­æ–‡å­—');
                     return;
                 }
            } else {
                customVocab = chars.map(char => ({
                    l: 'custom',
                    char: char,
                    pinyin: '',
                    zhuyin: ''
                }));
            }
            
            localStorage.setItem(CUSTOM_VOCAB_KEY, JSON.stringify(customVocab));

            document.getElementById('lesson-select').value = 'custom';
            updateLessonData('custom');
            closeCustomModal();
        }

        let deferredPrompt;

        function initInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const btn = document.getElementById('install-btn');
                if(btn) btn.classList.remove('hidden');
            });
        }

        function triggerInstall() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                document.getElementById('install-modal').classList.remove('hidden');
            } else if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    document.getElementById('install-btn').classList.add('hidden');
                });
            } else {
                alert('è«‹æŒ‰ Ctrl+D (æˆ– Command+D) å°‡æ­¤é é¢åŠ å…¥æ›¸ç±¤ï¼Œæ–¹ä¾¿éš¨æ™‚ç·´ç¿’ï¼');
            }
        }

        function closeInstallModal() {
            document.getElementById('install-modal').classList.add('hidden');
        }

        // --- å­—å…¸æŸ¥è©¢åŠŸèƒ½ (Moedict API) ---
        function closeDictModal() {
            document.getElementById('dict-modal').classList.add('hidden');
        }

        function openOfficialMoe() {
            if (lessonVocab.length === 0) return;
            const item = lessonVocab[currentIndex];
            // è¤‡è£½ä¸¦è·³è½‰ (ç‚ºäº†æ–¹ä¾¿æœå°‹)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(item.char);
            }
            window.open('https://dict.mini.moe.edu.tw/', '_blank');
        }

        function showDictionary() {
            if (lessonVocab.length === 0) return;
            const item = lessonVocab[currentIndex];
            const char = item.char;

            const modal = document.getElementById('dict-modal');
            const contentArea = document.getElementById('dict-content-area');
            const loading = document.getElementById('dict-loading');
            
            modal.classList.remove('hidden');
            contentArea.innerHTML = '';
            loading.classList.remove('hidden');

            // Fetch from Moedict API
            fetch(`https://www.moedict.tw/uni/${encodeURIComponent(char)}`)
                .then(res => {
                    if(!res.ok) throw new Error('æŸ¥ç„¡æ­¤å­—');
                    return res.json();
                })
                .then(data => {
                    renderDictData(data);
                })
                .catch(err => {
                    console.error(err);
                    contentArea.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-gray-400 mb-2">å­—å…¸è£¡æ‰¾ä¸åˆ°é€™å€‹å­—</div>
                            <button onclick="openOfficialMoe()" class="text-blue-500 hover:underline">è©¦è©¦æ•™è‚²éƒ¨å°å­—å…¸ â†—</button>
                        </div>
                    `;
                })
                .finally(() => {
                    loading.classList.add('hidden');
                });
        }

        function renderDictData(data) {
            const contentArea = document.getElementById('dict-content-area');
            let html = '';

            if (data.heteronyms) {
                data.heteronyms.forEach((h, index) => {
                    html += `<div class="dict-entry">`;
                    html += `<div class="dict-pronunciation">
                                <span class="dict-zhuyin">${h.bopomofo || ''}</span>
                                <span class="dict-pinyin">${h.pinyin || ''}</span>
                             </div>`;
                    
                    if (h.definitions) {
                        h.definitions.forEach((def, i) => {
                            html += `<div class="dict-def-item">
                                        <div>
                                            <span class="dict-def-num">${i + 1}.</span>
                                            <span class="dict-def-text">${def.def}</span>
                                        </div>`;
                            if (def.example) {
                                def.example.forEach(ex => {
                                    html += `<div class="dict-example">${ex}</div>`;
                                });
                            }
                            html += `</div>`;
                        });
                    }
                    html += `</div>`;
                });
            }

            contentArea.innerHTML = html;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            if(!toast) {
                const div = document.createElement('div');
                div.id = 'toast';
                div.className = 'fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm transition-opacity duration-300 opacity-0 pointer-events-none z-50';
                document.body.appendChild(div);
            }
            
            const el = document.getElementById('toast');
            el.innerText = message;
            el.style.opacity = 1;
            setTimeout(() => { el.style.opacity = 0; }, 3000);
        }
    </script>
</body>
</html>